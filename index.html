<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon222.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSK10.1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    <title>Анализатор ставок PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Все стили остаются без изменений */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #2c3e50;
            --secondary: #e74c3c;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            --card-bg: rgba(255, 255, 255, 0.98);
            --text-color: #333;
            --border-color: #ddd;
        }
        
        .dark-theme {
            --primary: #3498db;
            --secondary: #e74c3c;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --light: #34495e;
            --dark: #ecf0f1;
            --background: linear-gradient(135deg, #1a1a2e, #0d0d1a);
            --card-bg: rgba(26, 26, 46, 0.95);
            --text-color: #ecf0f1;
            --border-color: #2c3e50;
        }
        
        .bookmaker-theme {
            --primary: #1a5fb4;
            --secondary: #c64600;
            --success: #26a269;
            --danger: #c01c28;
            --warning: #e5a50a;
            --info: #1a5fb4;
            --light: #f6f5f4;
            --dark: #241f31;
            --background: #f6f5f4;
            --card-bg: #ffffff;
            --text-color: #241f31;
            --border-color: #deddda;
        }
        
        html {
            height: 100%;
            background: var(--background);
        }
        
        body {
            background: var(--background);
            color: var(--text-color);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
            transition: background 0.5s ease, color 0.5s ease;
            padding: 0;
            margin: 0;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            border-radius: 0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            transition: all 0.5s ease;
            min-height: 100vh;
            position: relative;
        }
        
        @media (min-width: 501px) {
            body {
                padding: 15px 0;
                align-items: flex-start;
            }
            
            .container {
                border-radius: 16px;
                min-height: auto;
                margin: 0 auto;
            }
        }
        
        header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 20px 18px;
            text-align: center;
            position: relative;
            padding-top: max(20px, env(safe-area-inset-top));
        }
        
        .header-controls {
            position: absolute;
            top: max(15px, env(safe-area-inset-top));
            right: 15px;
            display: flex;
            gap: 10px;
        }
        
        .theme-toggle, .info-btn, .bookmaker-toggle, .instructions-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 1.2rem;
        }
        
        .theme-toggle:hover, .info-btn:hover, .bookmaker-toggle:hover, .instructions-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(30deg);
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 18px;
            padding-bottom: max(18px, env(safe-area-inset-bottom));
        }
        
        .input-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            color: var(--primary);
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--primary);
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .input-group {
            margin-bottom: 12px;
        }
        
        .input-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        .input-field {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
            transition: border-color 0.3s;
            -webkit-appearance: none;
            appearance: none;
            caret-color: transparent;
            cursor: pointer;
        }
        
        .input-field:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .input-row .input-field {
            flex: 1;
        }
        
        .input-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            padding: 0 12px;
            height: 44px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .league-selector {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
        }
        
        .league-options {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .league-option {
            flex: 1;
            padding: 10px 8px;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            font-weight: 500;
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        .league-option.active {
            border-color: var(--primary);
            background: rgba(52, 152, 219, 0.2);
            font-weight: 600;
        }
        
        .bet-type-selector {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .bet-type-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        .bet-type-btn.active {
            border-color: var(--primary);
            background: rgba(52, 152, 219, 0.2);
        }
        
        .ml-controls {
            margin-top: 15px;
            padding: 12px;
            background: rgba(155, 89, 182, 0.1);
            border-radius: 10px;
            border-left: 4px solid #9b59b6;
        }
        
        .ml-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .ml-status {
            font-size: 0.85rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ml-status.active {
            color: #9b59b6;
            font-weight: 600;
        }
        
        .ml-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.8rem;
        }
        
        .ml-stat {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        
        .ml-stat-value {
            font-weight: 600;
            color: var(--primary);
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #9b59b6;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .results-section {
            padding: 18px;
            background: var(--light);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 18px;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .result-card {
            padding: 12px;
            border-radius: 10px;
            background: var(--card-bg);
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .result-title {
            font-size: 0.8rem;
            color: var(--primary);
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .result-value {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .positive {
            color: var(--success);
        }
        
        .negative {
            color: var(--danger);
        }
        
        .neutral {
            color: var(--info);
        }
        
        .ml-enhanced {
            color: #9b59b6;
        }
        
        .recommendation {
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            color: white;
            margin-top: 15px;
        }
        
        .recommendation.strong-buy {
            background: linear-gradient(90deg, var(--success), #2ecc71);
        }
        
        .recommendation.buy {
            background: linear-gradient(90deg, var(--info), #3498db);
        }
        
        .recommendation.avoid {
            background: linear-gradient(90deg, var(--danger), #c0392b);
        }
        
        .recommendation.ml-enhanced {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            position: relative;
            overflow: hidden;
        }
        
        .ml-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .recommendation-title {
            font-size: 1.2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .confidence-meter {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .confidence-text {
            margin-right: 10px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .confidence-bar {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            background: white;
        }
        
        .confidence-value {
            margin-left: 10px;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .details {
            margin-top: 15px;
            padding: 12px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
        }
        
        .details-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 0.85rem;
        }
        
        .detail-label {
            color: var(--text-color);
        }
        
        .detail-value {
            font-weight: 600;
            color: var(--primary);
            text-align: right;
        }
        
        .ml-correction {
            margin-top: 10px;
            padding: 8px;
            background: rgba(155, 89, 182, 0.1);
            border-radius: 6px;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
        }
        
        .deviation-explanation {
            margin-top: 15px;
            padding: 12px;
            background: rgba(243, 156, 18, 0.1);
            border-radius: 10px;
            font-size: 0.85rem;
        }
        
        .explanation-title {
            font-weight: 700;
            color: #f39c12;
            margin-bottom: 6px;
        }
        
        .explanation-text {
            margin-bottom: 6px;
            line-height: 1.4;
            color: var(--text-color);
        }
        
        .history-section {
            margin-top: 18px;
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 8px;
            background: var(--card-bg);
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .history-item:hover {
            background: rgba(52, 152, 219, 0.05);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-prediction {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .history-details {
            font-size: 0.75rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-top: 3px;
        }
        
        .history-confidence {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            min-width: 50px;
            text-align: center;
        }
        
        .history-confidence.positive {
            background: rgba(39, 174, 96, 0.2);
            color: var(--success);
        }
        
        .history-confidence.negative {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }
        
        .history-confidence.neutral {
            background: rgba(52, 152, 219, 0.2);
            color: var(--info);
        }
        
        .history-confidence.ml-enhanced {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 18px;
        }
        
        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #1c2833;
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: #d5dbdb;
        }
        
        .btn-ml {
            background: #9b59b6;
            color: white;
        }
        
        .btn-ml:hover {
            background: #8e44ad;
        }
        
        .success-animation {
            animation: successPulse 0.5s ease-in-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .ml-glow {
            animation: mlGlow 2s infinite alternate;
        }
        
        @keyframes mlGlow {
            from { box-shadow: 0 0 5px rgba(155, 89, 182, 0.5); }
            to { box-shadow: 0 0 15px rgba(155, 89, 182, 0.8); }
        }
        
        /* Модальное окно инструкции */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        
        .modal-title {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-align: center;
            font-weight: 700;
        }
        
        .instruction-section {
            margin-bottom: 25px;
        }
        
        .instruction-title {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .instruction-title i {
            color: var(--info);
        }
        
        .instruction-text {
            line-height: 1.6;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .instruction-list {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .instruction-list li {
            margin-bottom: 8px;
            line-height: 1.5;
            color: var(--text-color);
        }
        
        .strategy-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .strategy-card {
            padding: 15px;
            border-radius: 10px;
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid var(--info);
        }
        
        .strategy-card.strong-buy {
            background: rgba(39, 174, 96, 0.1);
            border-left-color: var(--success);
        }
        
        .strategy-card.buy {
            background: rgba(52, 152, 219, 0.1);
            border-left-color: var(--info);
        }
        
        .strategy-card.avoid {
            background: rgba(231, 76, 60, 0.1);
            border-left-color: var(--danger);
        }
        
        .strategy-card.ml-enhanced {
            background: rgba(155, 89, 182, 0.1);
            border-left-color: #9b59b6;
        }
        
        .strategy-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .strategy-desc {
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .tips-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .tip-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            background: rgba(243, 156, 18, 0.1);
            border-radius: 8px;
        }
        
        .tip-icon {
            color: var(--warning);
            font-size: 1.2rem;
            margin-top: 2px;
        }
        
        .tip-text {
            flex: 1;
            line-height: 1.5;
        }
        
        /* Стили для формы реального счета */
        .real-score-section {
            margin-top: 15px;
            padding: 12px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .real-score-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }
        
        .real-score-inputs .input-field {
            flex: 1;
        }
        
        .save-real-score-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .save-real-score-btn:hover {
            background: #2980b9;
        }
        
        .ml-feedback-section {
            margin-top: 15px;
            padding: 12px;
            background: rgba(155, 89, 182, 0.1);
            border-radius: 10px;
            border-left: 4px solid #9b59b6;
        }
        
        .ml-feedback-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .feedback-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 0.85rem;
        }
        
        .feedback-label {
            color: var(--text-color);
        }
        
        .feedback-value {
            font-weight: 600;
            color: var(--primary);
        }
        
        .feedback-value.positive {
            color: var(--success);
        }
        
        .feedback-value.negative {
            color: var(--danger);
        }
        
        /* Кастомная клавиатура */
        .custom-keyboard {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 10px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 999;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        
        .custom-keyboard.active {
            transform: translateY(0);
        }
        
        .keyboard-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .keyboard-btn {
            flex: 1;
            margin: 0 4px;
            height: 50px;
            border: none;
            border-radius: 8px;
            background: var(--light);
            color: var(--text-color);
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .keyboard-btn:active {
            background: var(--primary);
            color: white;
            transform: scale(0.95);
        }
        
        .keyboard-btn.double {
            flex: 2;
        }
        
        .keyboard-btn.action {
            background: var(--primary);
            color: white;
        }
        
        .keyboard-btn.action:active {
            background: var(--secondary);
        }
        
        .keyboard-btn.special {
            background: var(--warning);
            color: white;
        }
        
        .keyboard-btn.special:active {
            background: #e67e22;
        }
        
        .keyboard-close {
            position: absolute;
            top: -40px;
            right: 10px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .keyboard-close:active {
            background: var(--light);
        }
        
        /* Модальное окно деталей истории */
        .history-detail-modal .modal-content {
            max-width: 450px;
        }
        
        .history-detail-section {
            margin-bottom: 20px;
        }
        
        .history-detail-title {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .history-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background: rgba(52, 152, 219, 0.1);
            padding: 15px;
            border-radius: 10px;
        }
        
        .history-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .history-detail-label {
            font-weight: 500;
            color: var(--text-color);
        }
        
        .history-detail-value {
            font-weight: 600;
            color: var(--primary);
        }
        
        .history-result-section {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .history-result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .history-result-card {
            padding: 10px;
            border-radius: 8px;
            background: var(--card-bg);
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .history-recommendation {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: white;
            margin-top: 15px;
        }
        
        .history-recommendation.strong-buy {
            background: linear-gradient(90deg, var(--success), #2ecc71);
        }
        
        .history-recommendation.buy {
            background: linear-gradient(90deg, var(--info), #3498db);
        }
        
        .history-recommendation.avoid {
            background: linear-gradient(90deg, var(--danger), #c0392b);
        }
        
        .history-recommendation.ml-enhanced {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
        }
        
        .history-confidence-meter {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .history-confidence-bar {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .history-confidence-fill {
            height: 100%;
            border-radius: 4px;
            background: white;
        }
        
        /* Адаптация для iPhone */
        @media (max-width: 500px) {
            .container {
                max-width: 100%;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .result-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .league-options {
                flex-direction: column;
            }
            
            .confidence-meter {
                flex-direction: column;
                gap: 8px;
            }
            
            .confidence-bar {
                width: 100%;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .ml-stats {
                grid-template-columns: 1fr;
            }
            
            .history-list {
                max-height: 150px;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .header-controls {
                gap: 5px;
            }
            
            .keyboard-btn {
                height: 45px;
                font-size: 1.1rem;
            }
            
            .history-detail-grid {
                grid-template-columns: 1fr;
            }
            
            .history-result-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Для цифровой клавиатуры на iOS */
        input[type="number"] {
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[inputmode="numeric"] {
            -webkit-appearance: none;
            appearance: none;
        }
        
        .theme-transition {
            transition: all 0.5s ease;
        }
        
        /* Новые стили для сохранения данных формы */
        .saved-data-notice {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--primary);
        }
        
        .saved-data-notice i {
            color: var(--success);
        }
        
        .restore-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: auto;
        }
        
        .restore-btn:hover {
            background: #219653;
        }
        
        /* Новые стили для реальных результатов в истории */
        .real-results-section {
            margin-top: 15px;
            padding: 12px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 10px;
            border-left: 4px solid var(--success);
        }
        
        .real-results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .real-result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 0.85rem;
        }
        
        .real-result-label {
            color: var(--text-color);
        }
        
        .real-result-value {
            font-weight: 600;
            color: var(--primary);
        }
        
        .real-result-value.positive {
            color: var(--success);
        }
        
        .real-result-value.negative {
            color: var(--danger);
        }
        
        .ml-training-section {
            margin-top: 15px;
            padding: 12px;
            background: rgba(155, 89, 182, 0.1);
            border-radius: 10px;
            border-left: 4px solid #9b59b6;
        }
        
        .ml-training-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .training-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 0.85rem;
        }
        
        .training-label {
            color: var(--text-color);
        }
        
        .training-value {
            font-weight: 600;
            color: var(--primary);
        }
        
        .training-value.positive {
            color: var(--success);
        }
        
        .training-value.negative {
            color: var(--danger);
        }
        
        .training-value.neutral {
            color: var(--info);
        }
        
        .history-item-with-real {
            position: relative;
        }
        
        .history-item-with-real::after {
            content: "✓";
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--success);
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Новые стили для инструкции по расчетам */
        .formula-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .formula-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .formula {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .formula-explanation {
            margin-top: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .formula-variables {
            margin-top: 15px;
        }
        
        .variable-item {
            display: flex;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .variable-name {
            font-weight: 600;
            min-width: 120px;
            color: var(--primary);
        }
        
        .variable-desc {
            flex: 1;
        }
        
        .calculation-example {
            margin-top: 20px;
            padding: 15px;
            background: rgba(243, 156, 18, 0.1);
            border-radius: 10px;
            border-left: 4px solid #f39c12;
        }
        
        .example-title {
            font-weight: 700;
            color: #f39c12;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .example-step {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
        }
        
        .example-step:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .example-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .example-value {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 5px 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .example-result {
            font-weight: 700;
            color: var(--success);
            margin-top: 5px;
        }
        
        /* Новые стили для улучшенного отображения реального счета */
        .real-score-saved {
            background: rgba(39, 174, 96, 0.1) !important;
            border-left: 4px solid var(--success) !important;
        }
        
        .real-score-success {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 600;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .real-score-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .real-score-edit-btn {
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            flex: 1;
        }
        
        .real-score-edit-btn:hover {
            background: #e67e22;
        }
        
        .real-score-clear-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            flex: 1;
        }
        
        .real-score-clear-btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-controls">
                <button class="instructions-btn" id="instructions-btn">
                    <i class="fas fa-book"></i>
                </button>
                <button class="info-btn" id="info-btn">
                    <i class="fas fa-info"></i>
                </button>
                <button class="bookmaker-toggle" id="bookmaker-toggle">
                    <i class="fas fa-palette"></i>
                </button>
                <button class="theme-toggle" id="theme-toggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
            <h1>Анализатор ставок PRO</h1>
            <div class="subtitle">AI-анализ с ML-корректировкой</div>
        </header>
        
        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">Данные матча</h2>
                
                <div class="league-selector">
                    <div class="input-label">Лига:</div>
                    <div class="league-options">
                        <div class="league-option active" data-league="nba">NBA (4×12)</div>
                        <div class="league-option" data-league="fibа">ФИБА (4×10)</div>
                        <div class="league-option" data-league="cyber">Кибер (4×5)</div>
                    </div>
                </div>
                
                <div class="input-grid">
                    <div class="input-group">
                        <label class="input-label">Текущий счет</label>
                        <div class="input-row">
                            <input type="text" class="input-field" id="score1" placeholder="0" min="0" inputmode="none" readonly>
                            <div class="input-icon">:</div>
                            <input type="text" class="input-field" id="score2" placeholder="0" min="0" inputmode="none" readonly>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Период</label>
                        <select class="input-field" id="period">
                            <option value="1">1-я четверть</option>
                            <option value="2">2-я четверть</option>
                            <option value="3">3-я четверть</option>
                            <option value="4">4-я четверть</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Время в четверти</label>
                        <div class="input-row">
                            <input type="text" class="input-field" id="minutes" placeholder="мин" min="0" max="12" inputmode="none" readonly>
                            <div class="input-icon">:</div>
                            <input type="text" class="input-field" id="seconds" placeholder="сек" min="0" max="59" inputmode="none" readonly>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Тотал букмекера</label>
                        <input type="text" class="input-field" id="line-total" placeholder="215.5" step="0.1" inputmode="none" readonly>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Тип ставки</label>
                    <div class="bet-type-selector">
                        <div class="bet-type-btn active" id="bet-over">ТБ (Тотал больше)</div>
                        <div class="bet-type-btn" id="bet-under">ТМ (Тотал меньше)</div>
                    </div>
                </div>
                
                <div class="ml-controls">
                    <div class="ml-toggle">
                        <div class="ml-status" id="ml-status">
                            <i class="fas fa-brain"></i>
                            <span>ML-корректировка</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="ml-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="ml-stats">
                        <div class="ml-stat">
                            <span>Точность ML:</span>
                            <span class="ml-stat-value" id="ml-accuracy">--%</span>
                        </div>
                        <div class="ml-stat">
                            <span>Корректировка:</span>
                            <span class="ml-stat-value" id="ml-adjustment">--%</span>
                        </div>
                        <div class="ml-stat">
                            <span>Анализов в базе:</span>
                            <span class="ml-stat-value" id="ml-data-count">0</span>
                        </div>
                        <div class="ml-stat">
                            <span>Улучшение:</span>
                            <span class="ml-stat-value" id="ml-improvement">+--%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Уведомление о сохраненных данных -->
                <div class="saved-data-notice" id="saved-data-notice" style="display: none;">
                    <i class="fas fa-save"></i>
                    <span>Данные матча сохранены</span>
                    <button class="restore-btn" id="restore-data-btn">Восстановить</button>
                </div>
            </div>
            
            <div class="real-score-section" id="real-score-section">
                <div class="input-label">Реальный итоговый счет (после матча)</div>
                <div class="real-score-inputs">
                    <input type="text" class="input-field" id="real-score1" placeholder="0" min="0" inputmode="none" readonly>
                    <div class="input-icon">:</div>
                    <input type="text" class="input-field" id="real-score2" placeholder="0" min="0" inputmode="none" readonly>
                    <button class="save-real-score-btn" id="save-real-score-btn">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                </div>
                <!-- Блок для отображения успешного сохранения -->
                <div id="real-score-success" style="display: none;"></div>
                <!-- Блок для действий с реальным счетом -->
                <div class="real-score-actions" id="real-score-actions" style="display: none;">
                    <button class="real-score-edit-btn" id="real-score-edit-btn">
                        <i class="fas fa-edit"></i> Изменить
                    </button>
                    <button class="real-score-clear-btn" id="real-score-clear-btn">
                        <i class="fas fa-trash"></i> Очистить
                    </button>
                </div>
            </div>
            
            <div class="ml-feedback-section">
                <div class="input-label">ML-обратная связь</div>
                <div class="ml-feedback-grid">
                    <div class="feedback-item">
                        <span class="feedback-label">Прогноз vs Реальность:</span>
                        <span class="feedback-value neutral" id="prediction-accuracy">--</span>
                    </div>
                    <div class="feedback-item">
                        <span class="feedback-label">Рекомендация:</span>
                        <span class="feedback-value neutral" id="recommendation-accuracy">--</span>
                    </div>
                    <div class="feedback-item">
                        <span class="feedback-label">Ошибка прогноза:</span>
                        <span class="feedback-value neutral" id="prediction-error">--</span>
                    </div>
                    <div class="feedback-item">
                        <span class="feedback-label">Статус обучения:</span>
                        <span class="feedback-value neutral" id="training-status">Не обучено</span>
                    </div>
                </div>
            </div>
            
            <div class="results-section">
                <h2 class="section-title">Результаты анализа</h2>
                
                <div class="result-grid">
                    <div class="result-card">
                        <div class="result-title">Прогнозируемый тотал</div>
                        <div class="result-value neutral" id="predicted-total">--</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-title">Отклонение от линии</div>
                        <div class="result-value neutral" id="deviation-value">--</div>
                    </div>
                </div>
                
                <div class="recommendation" id="recommendation">
                    <div class="recommendation-title" id="recommendation-text">Введите данные для расчета</div>
                    <div class="confidence-meter">
                        <span class="confidence-text">Уверенность:</span>
                        <div class="confidence-bar">
                            <div class="confidence-fill" id="confidence-bar" style="width: 0%"></div>
                        </div>
                        <span class="confidence-value" id="confidence-value">0%</span>
                    </div>
                    <div class="ml-badge" id="ml-badge" style="display: none;">AI Enhanced</div>
                </div>
                
                <div class="ml-correction" id="ml-correction" style="display: none;">
                    <span>ML-корректировка уверенности:</span>
                    <span class="ml-stat-value" id="ml-correction-value">+0%</span>
                </div>
                
                <div class="details">
                    <div class="details-title">Детали расчета</div>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Темп игры:</span>
                            <span class="detail-value" id="pace-value">-- оч/мин</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Осталось времени:</span>
                            <span class="detail-value" id="time-left">-- мин</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Порог отклонения:</span>
                            <span class="detail-value" id="threshold-value">5.0 оч</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Тип лиги:</span>
                            <span class="detail-value" id="league-type">NBA</span>
                        </div>
                    </div>
                </div>
                
                <div class="deviation-explanation">
                    <div class="explanation-title">Почему ТБ/ТМ?</div>
                    <div class="explanation-text">
                        <strong>ТБ (Тотал больше)</strong> рекомендуется, когда прогноз ВЫШЕ тотала букмекера на 5+ очков.
                    </div>
                    <div class="explanation-text">
                        <strong>ТМ (Тотал меньше)</strong> рекомендуется, когда прогноз НИЖЕ тотала букмекера на 5+ очков.
                    </div>
                    <div class="explanation-text">
                        Чем больше отклонение, тем выше уверенность в рекомендации.
                    </div>
                </div>
            </div>
            
            <div class="history-section">
                <h2 class="section-title">История расчетов</h2>
                <div class="history-list" id="history-list">
                    <!-- История будет добавляться здесь -->
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="calculate-btn">Рассчитать</button>
                <button class="btn btn-secondary" id="clear-btn">Очистить</button>
                <button class="btn btn-ml" id="ml-train-btn">Обучить ML</button>
            </div>
        </div>
    </div>

    <!-- Кастомная клавиатура -->
    <div class="custom-keyboard" id="custom-keyboard">
        <button class="keyboard-close" id="keyboard-close">
            <i class="fas fa-times"></i>
        </button>
        <div class="keyboard-row">
            <button class="keyboard-btn" data-value="1">1</button>
            <button class="keyboard-btn" data-value="2">2</button>
            <button class="keyboard-btn" data-value="3">3</button>
            <button class="keyboard-btn action" data-action="backspace">
                <i class="fas fa-backspace"></i>
            </button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-btn" data-value="4">4</button>
            <button class="keyboard-btn" data-value="5">5</button>
            <button class="keyboard-btn" data-value="6">6</button>
            <button class="keyboard-btn action" data-action="clear">
                C
            </button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-btn" data-value="7">7</button>
            <button class="keyboard-btn" data-value="8">8</button>
            <button class="keyboard-btn" data-value="9">9</button>
            <button class="keyboard-btn special" data-action="done">
                Готово
            </button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-btn double" data-value="0">0</button>
            <button class="keyboard-btn" data-value=".">.</button>
            <button class="keyboard-btn action" data-action="delete">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>

    <!-- Модальное окно инструкции -->
    <div class="modal-overlay" id="instruction-modal">
        <div class="modal-content">
            <button class="modal-close" id="modal-close">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title">🤖 AI Анализатор ставок PRO</h2>
            
            <div class="instruction-section">
                <h3 class="instruction-title"><i class="fas fa-robot"></i> ML-корректировка</h3>
                <p class="instruction-text">Наш анализатор теперь использует машинное обучение для улучшения точности прогнозов на основе вашей истории ставок.</p>
                
                <div class="strategy-card ml-enhanced">
                    <div class="strategy-title">🤖 AI-АНАЛИЗ ВКЛЮЧЕН</div>
                    <div class="strategy-desc">
                        Система анализирует ваши предыдущие расчеты и корректирует уверенность в рекомендациях:<br>
                        • <strong>Автокорректировка</strong> на основе точности предыдущих прогнозов<br>
                        • <strong>Адаптивный порог</strong> - автоматическая настройка чувствительности<br>
                        • <strong>Умный учет трендов</strong> - анализ успешности в разных лигах<br>
                        • <strong>Персонализация</strong> - система учится на ваших данных
                    </div>
                </div>
            </div>
            
            <div class="instruction-section">
                <h3 class="instruction-title"><i class="fas fa-play-circle"></i> Как использовать анализатор</h3>
                <p class="instruction-text">Анализатор ставок PRO помогает определить выгодные ставки на тотал в баскетболе на основе текущей статистики матча.</p>
                
                <ol class="instruction-list">
                    <li><strong>Выберите лигу</strong> - укажите тип баскетбольной лиги (NBA, ФИБА или Кибер)</li>
                    <li><strong>Введите текущий счет</strong> - актуальный счет матча на момент анализа</li>
                    <li><strong>Укажите период и время</strong> - текущая четверть и оставшееся в ней время</li>
                    <li><strong>Введите тотал букмекера</strong> - значение тотала, предлагаемое букмекером</li>
                    <li><strong>Выберите тип ставки</strong> - ТБ (тотал больше) или ТМ (тотал меньше)</li>
                    <li><strong>Включите ML-корректировку</strong> для AI-улучшения точности</li>
                    <li><strong>Нажмите "Рассчитать"</strong> - получите прогноз и рекомендацию</li>
                    <li><strong>После матча введите реальный счет</strong> для обучения ML-модели</li>
                </ol>
            </div>
            
            <div class="instruction-section">
                <h3 class="instruction-title"><i class="fas fa-chart-line"></i> Стратегия принятия решений</h3>
                <p class="instruction-text">Основано на отклонении прогнозируемого тотала от линии букмекера:</p>
                
                <div class="strategy-grid">
                    <div class="strategy-card strong-buy">
                        <div class="strategy-title">СТРОНГ ТБ/ТМ ⬆️⬇️</div>
                        <div class="strategy-desc">
                            <strong>Отклонение: >5 очков</strong><br>
                            Высокая уверенность (15-25%)<br>
                            Рекомендуется делать ставку - сильный сигнал
                        </div>
                    </div>
                    
                    <div class="strategy-card buy">
                        <div class="strategy-title">ТБ/ТМ ✅</div>
                        <div class="strategy-desc">
                            <strong>Отклонение: 1-5 очков</strong><br>
                            Средняя уверенность (5-15%)<br>
                            Можно рассмотреть ставку - умеренный сигнал
                        </div>
                    </div>
                    
                    <div class="strategy-card avoid">
                        <div class="strategy-title">ИЗБЕГАТЬ ❌</div>
                        <div class="strategy-desc">
                            <strong>Отклонение: <1 очка</strong><br>
                            Низкая уверенность (0-5%)<br>
                            Не рекомендуется - слабый или обратный сигнал
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="instruction-section">
                <h3 class="instruction-title"><i class="fas fa-lightbulb"></i> Профессиональные советы</h3>
                
                <div class="tips-grid">
                    <div class="tip-item">
                        <div class="tip-icon"><i class="fas fa-brain"></i></div>
                        <div class="tip-text">
                            <strong>Включите ML-корректировку</strong> - система становится точнее с каждым использованием, обучаясь на ваших данных
                        </div>
                    </div>
                    
                    <div class="tip-item">
                        <div class="tip-icon"><i class="fas fa-clock"></i></div>
                        <div class="tip-text">
                            <strong>Анализируйте во время матча</strong> - лучшие результаты при анализе после 2-3 четвертей, когда темп игры установился
                        </div>
                    </div>
                    
                    <div class="tip-item">
                        <div class="tip-icon"><i class="fas fa-basketball-ball"></i></div>
                        <div class="tip-text">
                            <strong>Учитывайте тип лиги</strong> - в кибербаскетболе темп выше, поэтому используется множитель 1.15
                        </div>
                    </div>
                    
                    <div class="tip-item">
                        <div class="tip-icon"><i class="fas fa-chart-bar"></i></div>
                        <div class="tip-text">
                            <strong>Вводите реальные результаты</strong> - это позволяет ML-модели обучаться и улучшать точность прогнозов
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно деталей истории -->
    <div class="modal-overlay history-detail-modal" id="history-detail-modal">
        <div class="modal-content">
            <button class="modal-close" id="history-modal-close">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title">Детали расчета</h2>
            
            <div class="history-detail-section">
                <h3 class="history-detail-title"><i class="fas fa-info-circle"></i> Исходные данные</h3>
                <div class="history-detail-grid">
                    <div class="history-detail-item">
                        <span class="history-detail-label">Счет:</span>
                        <span class="history-detail-value" id="detail-score">0:0</span>
                    </div>
                    <div class="history-detail-item">
                        <span class="history-detail-label">Период:</span>
                        <span class="history-detail-value" id="detail-period">1-я четверть</span>
                    </div>
                    <div class="history-detail-item">
                        <span class="history-detail-label">Время в четверти:</span>
                        <span class="history-detail-value" id="detail-time">0:00</span>
                    </div>
                    <div class="history-detail-item">
                        <span class="history-detail-label">Лига:</span>
                        <span class="history-detail-value" id="detail-league">NBA</span>
                    </div>
                    <div class="history-detail-item">
                        <span class="history-detail-label">Тотал букмекера:</span>
                        <span class="history-detail-value" id="detail-line-total">0</span>
                    </div>
                    <div class="history-detail-item">
                        <span class="history-detail-label">Тип ставки:</span>
                        <span class="history-detail-value" id="detail-bet-type">ТБ</span>
                    </div>
                </div>
            </div>
            
            <div class="history-detail-section">
                <h3 class="history-detail-title"><i class="fas fa-chart-bar"></i> Результаты анализа</h3>
                <div class="history-result-section">
                    <div class="history-result-grid">
                        <div class="history-result-card">
                            <div class="result-title">Прогнозируемый тотал</div>
                            <div class="result-value neutral" id="detail-predicted-total">--</div>
                        </div>
                        
                        <div class="history-result-card">
                            <div class="result-title">Отклонение от линии</div>
                            <div class="result-value neutral" id="detail-deviation">--</div>
                        </div>
                    </div>
                    
                    <div class="history-recommendation" id="detail-recommendation">
                        <div class="recommendation-title" id="detail-recommendation-text">Введите данные для расчета</div>
                        <div class="history-confidence-meter">
                            <span class="confidence-text">Уверенность:</span>
                            <div class="history-confidence-bar">
                                <div class="history-confidence-fill" id="detail-confidence-bar" style="width: 0%"></div>
                            </div>
                            <span class="confidence-value" id="detail-confidence-value">0%</span>
                        </div>
                    </div>
                    
                    <div class="ml-correction" id="detail-ml-correction" style="display: none;">
                        <span>ML-корректировка уверенности:</span>
                        <span class="ml-stat-value" id="detail-ml-correction-value">+0%</span>
                    </div>
                </div>
            </div>
            
            <!-- Новая секция: Реальные результаты -->
            <div class="real-results-section" id="detail-real-results" style="display: none;">
                <h3 class="history-detail-title"><i class="fas fa-check-circle"></i> Реальные результаты</h3>
                <div class="real-results-grid">
                    <div class="real-result-item">
                        <span class="real-result-label">Реальный счет:</span>
                        <span class="real-result-value" id="detail-real-score">0:0</span>
                    </div>
                    <div class="real-result-item">
                        <span class="real-result-label">Реальный тотал:</span>
                        <span class="real-result-value" id="detail-real-total">0</span>
                    </div>
                    <div class="real-result-item">
                        <span class="real-result-label">Ошибка прогноза:</span>
                        <span class="real-result-value" id="detail-prediction-error">0 очков</span>
                    </div>
                    <div class="real-result-item">
                        <span class="real-result-label">Точность прогноза:</span>
                        <span class="real-result-value" id="detail-prediction-accuracy">0%</span>
                    </div>
                    <div class="real-result-item">
                        <span class="real-result-label">Рекомендация:</span>
                        <span class="real-result-value" id="detail-recommendation-correct">Нет данных</span>
                    </div>
                    <div class="real-result-item">
                        <span class="real-result-label">Внесено в ML:</span>
                        <span class="real-result-value" id="detail-ml-trained">Нет</span>
                    </div>
                </div>
            </div>
            
            <!-- Новая секция: Обучение ML -->
            <div class="ml-training-section" id="detail-ml-training" style="display: none;">
                <h3 class="history-detail-title"><i class="fas fa-graduation-cap"></i> Обучение ML на этом расчете</h3>
                <div class="ml-training-grid">
                    <div class="training-item">
                        <span class="training-label">Вес в обучении:</span>
                        <span class="training-value" id="detail-ml-weight">0%</span>
                    </div>
                    <div class="training-item">
                        <span class="training-label">Влияние на точность:</span>
                        <span class="training-value" id="detail-ml-impact">0%</span>
                    </div>
                    <div class="training-item">
                        <span class="training-label">Корректировка ML:</span>
                        <span class="training-value" id="detail-ml-adjustment">0%</span>
                    </div>
                    <div class="training-item">
                        <span class="training-label">Статус обучения:</span>
                        <span class="training-value" id="detail-ml-status">Не обучено</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно инструкции по расчетам -->
    <div class="modal-overlay" id="calculations-instruction-modal">
        <div class="modal-content">
            <button class="modal-close" id="calculations-modal-close">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title">📊 Детали расчетов Анализатора ставок</h2>
            
            <div class="instruction-section">
                <h3 class="instruction-title"><i class="fas fa-calculator"></i> Формула прогнозируемого тотала</h3>
                <p class="instruction-text">Анализатор использует математическую модель для прогнозирования итогового тотала матча на основе текущей статистики.</p>
                
                <div class="formula-section">
                    <div class="formula-title">Основная формула расчета:</div>
                    <div class="formula">
                        Прогнозируемый тотал = Текущий тотал + (Текущий темп × Оставшееся время × Множитель лиги)
                    </div>
                    
                    <div class="formula-explanation">
                        Эта формула позволяет экстраполировать текущий темп игры на оставшееся время матча.
                    </div>
                    
                    <div class="formula-variables">
                        <div class="variable-item">
                            <div class="variable-name">Текущий тотал:</div>
                            <div class="variable-desc">Сумма очков обеих команд на момент анализа (score1 + score2)</div>
                        </div>
                        <div class="variable-item">
                            <div class="variable-name">Текущий темп:</div>
                            <div class="variable-desc">Текущий тотал / Прошедшее время (в минутах)</div>
                        </div>
                        <div class="variable-item">
                            <div class="variable-name">Оставшееся время:</div>
                            <div class="variable-desc">Оставшееся в текущей четверти + Полные оставшиеся четверти (в минутах)</div>
                        </div>
                        <div class="variable-item">
                            <div class="variable-name">Множитель лиги:</div>
                            <div class="variable-desc">Коэффициент для разных лиг (NBA: 1.0, ФИБА: 1.0, Кибер: 1.15)</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="instruction-section">
                <h3 class="instruction-title"><i class="fas fa-clock"></i> Расчет времени</h3>
                <p class="instruction-text">Точный расчет времени играет ключевую роль в прогнозировании тотала.</p>
                
                <div class="formula-section">
                    <div class="formula-title">Формулы расчета времени:</div>
                    
                    <div class="formula">
                        Прошедшее время = (Период - 1) × Минут в периоде + Прошедшее в текущем периоде
                    </div>
                    
                    <div class="formula">
                        Оставшееся время = Оставшееся в текущем периоде + (Всего периодов - Текущий период) × Минут в периоде
                    </div>
                    
                    <div class="formula-variables">
                        <div class="variable-item">
                            <div class="variable-name">Минут в периоде:</div>
                            <div class="variable-desc">NBA: 12 мин, ФИБА: 10 мин, Кибер: 5 мин</div>
                        </div>
                        <div class="variable-item">
                            <div class="variable-name">Всего периодов:</div>
                            <div class="variable-desc">Для всех лиг: 4 периода (четверти)</div>
                        </div>
                        <div class="variable-item">
                            <div class="variable-name">Прошедшее в текущем периоде:</div>
                            <div class="variable-desc">Минуты + (Секунды / 60)</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="instruction-section">
                <h3 class="instruction-title"><i class="fas fa-chart-bar"></i> Расчет отклонения и уверенности</h3>
                <p class="instruction-text">На основе отклонения прогнозируемого тотала от линии букмекера определяется уверенность в рекомендации.</p>
                
                <div class="formula-section">
                    <div class="formula-title">Формула отклонения:</div>
                    <div class="formula">
                        Отклонение = Прогнозируемый тотал - Тотал букмекера
                    </div>
                    
                    <div class="formula-title">Расчет уверенности:</div>
                    <div class="formula-explanation">
                        Уверенность рассчитывается на основе отклонения и выбранного типа ставки (ТБ/ТМ):
                    </div>
                    
                    <div class="formula-variables">
                        <div class="variable-item">
                            <div class="variable-name">Для ТБ (Тотал больше):</div>
                            <div class="variable-desc">
                                • Отклонение > 5 очков: Высокая уверенность (15-25%)<br>
                                • Отклонение 1-5 очков: Средняя уверенность (5-15%)<br>
                                • Отклонение < 0 очков: Низкая уверенность (0-5%)
                            </div>
                        </div>
                        <div class="variable-item">
                            <div class="variable-name">Для ТМ (Тотал меньше):</div>
                            <div class="variable-desc">
                                • Отклонение < -5 очков: Высокая уверенность (15-25%)<br>
                                • Отклонение -1 до -5 очков: Средняя уверенность (5-15%)<br>
                                • Отклонение > 0 очков: Низкая уверенность (0-5%)
                            </div>
                        </div>
                    </div>
                    
                    <div class="formula-explanation">
                        <strong>Порог значительного отклонения:</strong> 5 очков. Отклонение более 5 очков дает высокую уверенность в рекомендации.
                    </div>
                </div>
            </div>
            
            <div class="instruction-section">
                <h3 class="instruction-title"><i class="fas fa-brain"></i> ML-корректировка</h3>
                <p class="instruction-text">Машинное обучение улучшает точность прогнозов на основе истории ваших расчетов.</p>
                
                <div class="formula-section">
                    <div class="formula-title">Формула ML-корректировки:</div>
                    <div class="formula">
                        Скорректированная уверенность = Базовая уверенность + (Точность ML × 15%)
                    </div>
                    
                    <div class="formula-explanation">
                        ML-модель анализирует вашу историю ставок и корректирует уверенность на основе:
                    </div>
                    
                    <div class="formula-variables">
                        <div class="variable-item">
                            <div class="variable-name">Точность ML:</div>
                            <div class="variable-desc">Процент правильных рекомендаций в вашей истории</div>
                        </div>
                        <div class="variable-item">
                            <div class="variable-name">Корректировка по лиге:</div>
                            <div class="variable-desc">Учитывается успешность прогнозов в разных лигах</div>
                        </div>
                        <div class="variable-item">
                            <div class="variable-name">Недавняя производительность:</div>
                            <div class="variable-desc">Учитываются последние 5 расчетов</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="instruction-section">
                <h3 class="instruction-title"><i class="fas fa-list-alt"></i> Пример расчета</h3>
                <p class="instruction-text">Рассмотрим подробный пример расчета прогнозируемого тотала.</p>
                
                <div class="calculation-example">
                    <div class="example-title">Пример: Матч NBA</div>
                    
                    <div class="example-step">
                        <div class="example-label">Исходные данные:</div>
                        <div class="example-value">Счет: 50:45 (Текущий тотал = 95 очков)</div>
                        <div class="example-value">Период: 2-я четверть</div>
                        <div class="example-value">Время в четверти: 5:30 (5.5 минут)</div>
                        <div class="example-value">Лига: NBA (4×12 минут)</div>
                        <div class="example-value">Тотал букмекера: 210.5</div>
                        <div class="example-value">Тип ставки: ТБ (Тотал больше)</div>
                    </div>
                    
                    <div class="example-step">
                        <div class="example-label">Расчет прошедшего времени:</div>
                        <div class="example-value">Прошедшее время = (2 - 1) × 12 + 5.5 = 17.5 минут</div>
                    </div>
                    
                    <div class="example-step">
                        <div class="example-label">Расчет текущего темпа:</div>
                        <div class="example-value">Текущий темп = 95 / 17.5 = 5.43 очка/минуту</div>
                    </div>
                    
                    <div class="example-step">
                        <div class="example-label">Расчет оставшегося времени:</div>
                        <div class="example-value">Оставшееся время = (12 - 5.5) + (4 - 2) × 12 = 6.5 + 24 = 30.5 минут</div>
                    </div>
                    
                    <div class="example-step">
                        <div class="example-label">Расчет прогнозируемого тотала:</div>
                        <div class="example-value">Прогнозируемый тотал = 95 + (5.43 × 30.5 × 1.0) = 95 + 165.615 = 260.615</div>
                    </div>
                    
                    <div class="example-step">
                        <div class="example-label">Расчет отклонения:</div>
                        <div class="example-value">Отклонение = 260.615 - 210.5 = +50.115 очков</div>
                    </div>
                    
                    <div class="example-step">
                        <div class="example-label">Рекомендация:</div>
                        <div class="example-value">При ставке на ТБ и отклонении >5 очков</div>
                        <div class="example-result">РЕКОМЕНДАЦИЯ: СТРОНГ ТБ с высокой уверенностью</div>
                    </div>
                </div>
            </div>
            
            <div class="instruction-section">
                <h3 class="instruction-title"><i class="fas fa-graduation-cap"></i> Обучение ML-модели</h3>
                <p class="instruction-text">После ввода реальных результатов матча ML-модель обучается на ваших данных.</p>
                
                <div class="formula-section">
                    <div class="formula-title">Процесс обучения ML:</div>
                    
                    <div class="formula-variables">
                        <div class="variable-item">
                            <div class="variable-name">Сбор данных:</div>
                            <div class="variable-desc">Сохраняются прогнозы и реальные результаты</div>
                        </div>
                        <div class="variable-item">
                            <div class="variable-name">Расчет точности:</div>
                            <div class="variable-desc">Точность = Правильные прогнозы / Всего прогнозов</div>
                        </div>
                        <div class="variable-item">
                            <div class="variable-name">Корректировка модели:</div>
                            <div class="variable-desc">Модель адаптируется под ваши успешные стратегии</div>
                        </div>
                        <div class="variable-item">
                            <div class="variable-name">Учет лиг:</div>
                            <div class="variable-desc">Отдельно анализируется точность в разных лигах</div>
                        </div>
                    </div>
                    
                    <div class="formula-explanation">
                        <strong>Минимальные требования для обучения:</strong> 3 расчета с реальными результатами.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Элементы DOM
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('i');
            const bookmakerToggle = document.getElementById('bookmaker-toggle');
            const bookmakerIcon = bookmakerToggle.querySelector('i');
            const infoBtn = document.getElementById('info-btn');
            const instructionsBtn = document.getElementById('instructions-btn');
            const instructionModal = document.getElementById('instruction-modal');
            const calculationsInstructionModal = document.getElementById('calculations-instruction-modal');
            const modalClose = document.getElementById('modal-close');
            const calculationsModalClose = document.getElementById('calculations-modal-close');
            
            const score1Input = document.getElementById('score1');
            const score2Input = document.getElementById('score2');
            const periodSelect = document.getElementById('period');
            const minutesInput = document.getElementById('minutes');
            const secondsInput = document.getElementById('seconds');
            const lineTotalInput = document.getElementById('line-total');
            const betOverBtn = document.getElementById('bet-over');
            const betUnderBtn = document.getElementById('bet-under');
            const calculateBtn = document.getElementById('calculate-btn');
            const clearBtn = document.getElementById('clear-btn');
            const leagueOptions = document.querySelectorAll('.league-option');
            
            // ML элементы
            const mlToggle = document.getElementById('ml-toggle');
            const mlStatus = document.getElementById('ml-status');
            const mlAccuracy = document.getElementById('ml-accuracy');
            const mlAdjustment = document.getElementById('ml-adjustment');
            const mlDataCount = document.getElementById('ml-data-count');
            const mlImprovement = document.getElementById('ml-improvement');
            const mlTrainBtn = document.getElementById('ml-train-btn');
            const mlBadge = document.getElementById('ml-badge');
            const mlCorrection = document.getElementById('ml-correction');
            const mlCorrectionValue = document.getElementById('ml-correction-value');
            
            // Элементы реального счета
            const realScore1Input = document.getElementById('real-score1');
            const realScore2Input = document.getElementById('real-score2');
            const saveRealScoreBtn = document.getElementById('save-real-score-btn');
            const realScoreSection = document.getElementById('real-score-section');
            const realScoreSuccess = document.getElementById('real-score-success');
            const realScoreActions = document.getElementById('real-score-actions');
            const realScoreEditBtn = document.getElementById('real-score-edit-btn');
            const realScoreClearBtn = document.getElementById('real-score-clear-btn');
            
            // Элементы обратной связи ML
            const predictionAccuracyEl = document.getElementById('prediction-accuracy');
            const recommendationAccuracyEl = document.getElementById('recommendation-accuracy');
            const predictionErrorEl = document.getElementById('prediction-error');
            const trainingStatusEl = document.getElementById('training-status');
            
            // Элементы результатов
            const predictedTotalEl = document.getElementById('predicted-total');
            const deviationValueEl = document.getElementById('deviation-value');
            const recommendationEl = document.getElementById('recommendation');
            const recommendationTextEl = document.getElementById('recommendation-text');
            const confidenceBarEl = document.getElementById('confidence-bar');
            const confidenceValueEl = document.getElementById('confidence-value');
            const paceValueEl = document.getElementById('pace-value');
            const timeLeftEl = document.getElementById('time-left');
            const thresholdValueEl = document.getElementById('threshold-value');
            const leagueTypeEl = document.getElementById('league-type');
            const historyListEl = document.getElementById('history-list');
            
            // Элементы сохранения данных
            const savedDataNotice = document.getElementById('saved-data-notice');
            const restoreDataBtn = document.getElementById('restore-data-btn');
            
            // Элементы модального окна деталей истории
            const historyDetailModal = document.getElementById('history-detail-modal');
            const historyModalClose = document.getElementById('history-modal-close');
            const detailScoreEl = document.getElementById('detail-score');
            const detailPeriodEl = document.getElementById('detail-period');
            const detailTimeEl = document.getElementById('detail-time');
            const detailLeagueEl = document.getElementById('detail-league');
            const detailLineTotalEl = document.getElementById('detail-line-total');
            const detailBetTypeEl = document.getElementById('detail-bet-type');
            const detailPredictedTotalEl = document.getElementById('detail-predicted-total');
            const detailDeviationEl = document.getElementById('detail-deviation');
            const detailRecommendationEl = document.getElementById('detail-recommendation');
            const detailRecommendationTextEl = document.getElementById('detail-recommendation-text');
            const detailConfidenceBarEl = document.getElementById('detail-confidence-bar');
            const detailConfidenceValueEl = document.getElementById('detail-confidence-value');
            const detailMlCorrectionEl = document.getElementById('detail-ml-correction');
            const detailMlCorrectionValueEl = document.getElementById('detail-ml-correction-value');
            
            // Новые элементы для реальных результатов в модальном окне
            const detailRealResultsSection = document.getElementById('detail-real-results');
            const detailRealScoreEl = document.getElementById('detail-real-score');
            const detailRealTotalEl = document.getElementById('detail-real-total');
            const detailPredictionErrorEl = document.getElementById('detail-prediction-error');
            const detailPredictionAccuracyEl = document.getElementById('detail-prediction-accuracy');
            const detailRecommendationCorrectEl = document.getElementById('detail-recommendation-correct');
            const detailMlTrainedEl = document.getElementById('detail-ml-trained');
            
            // Новые элементы для обучения ML в модальном окне
            const detailMlTrainingSection = document.getElementById('detail-ml-training');
            const detailMlWeightEl = document.getElementById('detail-ml-weight');
            const detailMlImpactEl = document.getElementById('detail-ml-impact');
            const detailMlAdjustmentEl = document.getElementById('detail-ml-adjustment');
            const detailMlStatusEl = document.getElementById('detail-ml-status');
            
            // Элементы кастомной клавиатуры
            const customKeyboard = document.getElementById('custom-keyboard');
            const keyboardClose = document.getElementById('keyboard-close');
            const keyboardButtons = document.querySelectorAll('.keyboard-btn');
            
            // Переменные состояния
            let currentLeague = 'nba';
            let currentBetType = 'over';
            let calculationHistory = [];
            let mlData = {
                enabled: true,
                accuracy: 0,
                totalPredictions: 0,
                correctPredictions: 0,
                adjustmentFactor: 1.0,
                leagueAccuracy: {},
                recentPerformance: [],
                trainedWithRealData: false,
                trainingHistory: [],
                // НОВОЕ: Добавляем расширенные ML-данные
                advancedStats: {
                    totalTrainingSessions: 0,
                    lastTrainingDate: null,
                    modelVersion: "1.0",
                    featureImportance: {
                        deviation: 0.35,
                        confidence: 0.25,
                        league: 0.20,
                        timeLeft: 0.15,
                        period: 0.05
                    }
                }
            };
            let currentTheme = 'light';
            let lastPrediction = null;
            let activeInput = null;
            let formData = {};
            let realScoreSaved = false;
            
            // Инициализация
            initializeApp();
            
            function initializeApp() {
                // Обработчики событий для лиг
                leagueOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        leagueOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        currentLeague = this.getAttribute('data-league');
                        updateLeagueInfo();
                        saveFormData();
                        autoCalculate();
                    });
                });
                
                // Обработчики для типа ставки
                betOverBtn.addEventListener('click', function() {
                    betOverBtn.classList.add('active');
                    betUnderBtn.classList.remove('active');
                    currentBetType = 'over';
                    saveFormData();
                    autoCalculate();
                });
                
                betUnderBtn.addEventListener('click', function() {
                    betUnderBtn.classList.add('active');
                    betOverBtn.classList.remove('active');
                    currentBetType = 'under';
                    saveFormData();
                    autoCalculate();
                });
                
                // Обработчики для полей ввода
                const inputFields = [score1Input, score2Input, minutesInput, secondsInput, lineTotalInput, realScore1Input, realScore2Input];
                inputFields.forEach(field => {
                    field.addEventListener('focus', showCustomKeyboard);
                    field.addEventListener('click', showCustomKeyboard);
                    field.addEventListener('input', function() {
                        saveFormData();
                        if (field !== realScore1Input && field !== realScore2Input) {
                            autoCalculate();
                        }
                    });
                });
                
                // Обработчик для селекта периода
                periodSelect.addEventListener('change', function() {
                    saveFormData();
                    autoCalculate();
                });
                
                // Кнопки действий
                calculateBtn.addEventListener('click', performCalculation);
                clearBtn.addEventListener('click', clearForm);
                mlTrainBtn.addEventListener('click', trainMLModel);
                saveRealScoreBtn.addEventListener('click', saveRealScore);
                restoreDataBtn.addEventListener('click', restoreFormData);
                
                // Обработчики для реального счета
                realScoreEditBtn.addEventListener('click', editRealScore);
                realScoreClearBtn.addEventListener('click', clearRealScore);
                
                // ML переключатель
                mlToggle.addEventListener('change', function() {
                    mlData.enabled = this.checked;
                    updateMLStatus();
                    saveMLData();
                    autoCalculate();
                });
                
                // Переключение темы
                themeToggle.addEventListener('click', toggleTheme);
                bookmakerToggle.addEventListener('click', toggleBookmakerTheme);
                
                // Модальные окна инструкций
                infoBtn.addEventListener('click', openInstructionModal);
                instructionsBtn.addEventListener('click', openCalculationsInstructionModal);
                modalClose.addEventListener('click', closeInstructionModal);
                calculationsModalClose.addEventListener('click', closeCalculationsInstructionModal);
                instructionModal.addEventListener('click', function(e) {
                    if (e.target === instructionModal) {
                        closeInstructionModal();
                    }
                });
                calculationsInstructionModal.addEventListener('click', function(e) {
                    if (e.target === calculationsInstructionModal) {
                        closeCalculationsInstructionModal();
                    }
                });
                
                // Модальное окно деталей истории
                historyModalClose.addEventListener('click', closeHistoryDetailModal);
                historyDetailModal.addEventListener('click', function(e) {
                    if (e.target === historyDetailModal) {
                        closeHistoryDetailModal();
                    }
                });
                
                // Кастомная клавиатура
                keyboardClose.addEventListener('click', hideCustomKeyboard);
                keyboardButtons.forEach(button => {
                    button.addEventListener('click', handleKeyboardInput);
                });
                
                // Загрузка истории и ML данных из localStorage
                loadHistory();
                loadMLData();
                loadTheme();
                loadFormData();
                checkRealScoreStatus();
                
                // Первоначальный расчет
                autoCalculate();
            }
            
            function checkRealScoreStatus() {
                const savedRealScore = localStorage.getItem('betAnalyzerRealScore');
                if (savedRealScore) {
                    const realScoreData = JSON.parse(savedRealScore);
                    realScore1Input.value = realScoreData.score1 || '';
                    realScore2Input.value = realScoreData.score2 || '';
                    realScoreSaved = true;
                    updateRealScoreUI();
                }
            }
            
            function updateRealScoreUI() {
                if (realScoreSaved) {
                    realScoreSection.classList.add('real-score-saved');
                    realScoreActions.style.display = 'flex';
                    saveRealScoreBtn.style.display = 'none';
                    realScore1Input.readOnly = true;
                    realScore2Input.readOnly = true;
                } else {
                    realScoreSection.classList.remove('real-score-saved');
                    realScoreActions.style.display = 'none';
                    saveRealScoreBtn.style.display = 'block';
                    realScore1Input.readOnly = false;
                    realScore2Input.readOnly = false;
                }
            }
            
            function editRealScore() {
                realScoreSaved = false;
                updateRealScoreUI();
                realScoreSuccess.style.display = 'none';
            }
            
            function clearRealScore() {
                realScore1Input.value = '';
                realScore2Input.value = '';
                realScoreSaved = false;
                updateRealScoreUI();
                realScoreSuccess.style.display = 'none';
                localStorage.removeItem('betAnalyzerRealScore');
            }
            
            function showCustomKeyboard(e) {
                activeInput = e.target;
                customKeyboard.classList.add('active');
                
                // Скрываем точку для целочисленных полей
                const decimalButton = customKeyboard.querySelector('[data-value="."]');
                if (activeInput === lineTotalInput) {
                    decimalButton.style.display = 'flex';
                } else {
                    decimalButton.style.display = 'none';
                }
            }
            
            function hideCustomKeyboard() {
                customKeyboard.classList.remove('active');
                activeInput = null;
            }
            
            function handleKeyboardInput(e) {
                if (!activeInput) return;
                
                const value = e.currentTarget.getAttribute('data-value');
                const action = e.currentTarget.getAttribute('data-action');
                
                if (value) {
                    // Добавляем цифру или точку
                    if (activeInput.value === '0' && value !== '.') {
                        activeInput.value = value;
                    } else {
                        activeInput.value += value;
                    }
                    
                    // Проверяем валидность для целочисленных полей
                    if (activeInput !== lineTotalInput) {
                        activeInput.value = activeInput.value.replace('.', '');
                    }
                } else if (action) {
                    switch(action) {
                        case 'backspace':
                            // Удаляем последний символ
                            activeInput.value = activeInput.value.slice(0, -1);
                            break;
                        case 'clear':
                            // Очищаем поле
                            activeInput.value = '';
                            break;
                        case 'delete':
                            // Удаляем все содержимое
                            activeInput.value = '';
                            break;
                        case 'done':
                            // Закрываем клавиатуру
                            hideCustomKeyboard();
                            break;
                    }
                }
                
                // Вызываем событие input для обновления расчетов
                activeInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
            
            function toggleTheme() {
                if (currentTheme === 'light') {
                    currentTheme = 'dark';
                    document.body.classList.add('dark-theme');
                    document.body.classList.remove('bookmaker-theme');
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                } else {
                    currentTheme = 'light';
                    document.body.classList.remove('dark-theme');
                    document.body.classList.remove('bookmaker-theme');
                    themeIcon.classList.remove('fa-sun');
                    themeIcon.classList.add('fa-moon');
                }
                
                // Сохраняем настройку темы
                localStorage.setItem('betAnalyzerTheme', currentTheme);
            }
            
            function toggleBookmakerTheme() {
                if (currentTheme === 'bookmaker') {
                    currentTheme = 'light';
                    document.body.classList.remove('bookmaker-theme');
                    bookmakerIcon.style.color = 'white';
                } else {
                    currentTheme = 'bookmaker';
                    document.body.classList.remove('dark-theme');
                    document.body.classList.add('bookmaker-theme');
                    bookmakerIcon.style.color = '#ffcc00';
                }
                
                // Сохраняем настройку темы
                localStorage.setItem('betAnalyzerTheme', currentTheme);
            }
            
            function loadTheme() {
                const savedTheme = localStorage.getItem('betAnalyzerTheme');
                if (savedTheme) {
                    currentTheme = savedTheme;
                    
                    if (currentTheme === 'dark') {
                        document.body.classList.add('dark-theme');
                        themeIcon.classList.remove('fa-moon');
                        themeIcon.classList.add('fa-sun');
                    } else if (currentTheme === 'bookmaker') {
                        document.body.classList.add('bookmaker-theme');
                        bookmakerIcon.style.color = '#ffcc00';
                    }
                }
            }
            
            function saveFormData() {
                formData = {
                    score1: score1Input.value,
                    score2: score2Input.value,
                    period: periodSelect.value,
                    minutes: minutesInput.value,
                    seconds: secondsInput.value,
                    lineTotal: lineTotalInput.value,
                    league: currentLeague,
                    betType: currentBetType,
                    realScore1: realScore1Input.value,
                    realScore2: realScore2Input.value,
                    timestamp: Date.now()
                };
                
                localStorage.setItem('betAnalyzerFormData', JSON.stringify(formData));
                
                // Показываем уведомление о сохраненных данных
                const hasData = score1Input.value || score2Input.value || minutesInput.value || 
                               secondsInput.value || lineTotalInput.value;
                if (hasData) {
                    savedDataNotice.style.display = 'flex';
                } else {
                    savedDataNotice.style.display = 'none';
                }
            }
            
            function loadFormData() {
                const savedFormData = localStorage.getItem('betAnalyzerFormData');
                if (savedFormData) {
                    formData = JSON.parse(savedFormData);
                    
                    // Восстанавливаем данные только если они не старше 24 часов
                    const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
                    if (formData.timestamp && formData.timestamp > oneDayAgo) {
                        score1Input.value = formData.score1 || '';
                        score2Input.value = formData.score2 || '';
                        periodSelect.value = formData.period || '1';
                        minutesInput.value = formData.minutes || '';
                        secondsInput.value = formData.seconds || '';
                        lineTotalInput.value = formData.lineTotal || '';
                        realScore1Input.value = formData.realScore1 || '';
                        realScore2Input.value = formData.realScore2 || '';
                        
                        // Восстанавливаем лигу
                        if (formData.league) {
                            currentLeague = formData.league;
                            leagueOptions.forEach(opt => {
                                opt.classList.remove('active');
                                if (opt.getAttribute('data-league') === currentLeague) {
                                    opt.classList.add('active');
                                }
                            });
                            updateLeagueInfo();
                        }
                        
                        // Восстанавливаем тип ставки
                        if (formData.betType) {
                            currentBetType = formData.betType;
                            if (currentBetType === 'over') {
                                betOverBtn.classList.add('active');
                                betUnderBtn.classList.remove('active');
                            } else {
                                betUnderBtn.classList.add('active');
                                betOverBtn.classList.remove('active');
                            }
                        }
                        
                        // Показываем уведомление о восстановленных данных
                        savedDataNotice.style.display = 'flex';
                        savedDataNotice.innerHTML = `
                            <i class="fas fa-history"></i>
                            <span>Данные матча восстановлены</span>
                            <button class="restore-btn" id="restore-data-btn">Очистить</button>
                        `;
                        
                        // Обновляем обработчик для кнопки восстановления
                        document.getElementById('restore-data-btn').addEventListener('click', clearForm);
                    }
                }
            }
            
            function restoreFormData() {
                if (Object.keys(formData).length > 0) {
                    score1Input.value = formData.score1 || '';
                    score2Input.value = formData.score2 || '';
                    periodSelect.value = formData.period || '1';
                    minutesInput.value = formData.minutes || '';
                    secondsInput.value = formData.seconds || '';
                    lineTotalInput.value = formData.lineTotal || '';
                    
                    // Восстанавливаем лигу
                    if (formData.league) {
                        currentLeague = formData.league;
                        leagueOptions.forEach(opt => {
                            opt.classList.remove('active');
                            if (opt.getAttribute('data-league') === currentLeague) {
                                opt.classList.add('active');
                            }
                        });
                        updateLeagueInfo();
                    }
                    
                    // Восстанавливаем тип ставки
                    if (formData.betType) {
                        currentBetType = formData.betType;
                        if (currentBetType === 'over') {
                            betOverBtn.classList.add('active');
                            betUnderBtn.classList.remove('active');
                        } else {
                            betUnderBtn.classList.add('active');
                            betOverBtn.classList.remove('active');
                        }
                    }
                    
                    autoCalculate();
                    
                    // Скрываем уведомление после восстановления
                    setTimeout(() => {
                        savedDataNotice.style.display = 'none';
                    }, 3000);
                }
            }
            
            function openInstructionModal() {
                instructionModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            function closeInstructionModal() {
                instructionModal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            function openCalculationsInstructionModal() {
                calculationsInstructionModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            function closeCalculationsInstructionModal() {
                calculationsInstructionModal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            function openHistoryDetailModal(historyItem) {
                // Заполняем модальное окно данными из истории
                detailScoreEl.textContent = historyItem.score;
                
                // Определяем название периода
                let periodName = '';
                switch(historyItem.period) {
                    case 1: periodName = '1-я четверть'; break;
                    case 2: periodName = '2-я четверть'; break;
                    case 3: periodName = '3-я четверть'; break;
                    case 4: periodName = '4-я четверть'; break;
                }
                detailPeriodEl.textContent = periodName;
                
                // Форматируем время
                detailTimeEl.textContent = `${historyItem.minutes}:${historyItem.seconds.toString().padStart(2, '0')}`;
                
                // Определяем название лиги
                let leagueName = '';
                switch(historyItem.league) {
                    case 'nba': leagueName = 'NBA'; break;
                    case 'fibа': leagueName = 'ФИБА'; break;
                    case 'cyber': leagueName = 'Кибер'; break;
                }
                detailLeagueEl.textContent = leagueName;
                
                detailLineTotalEl.textContent = historyItem.lineTotal;
                detailBetTypeEl.textContent = historyItem.betType === 'over' ? 'ТБ' : 'ТМ';
                detailPredictedTotalEl.textContent = historyItem.predictedTotal.toFixed(1);
                
                // Рассчитываем отклонение
                const deviation = historyItem.predictedTotal - historyItem.lineTotal;
                detailDeviationEl.textContent = `${deviation > 0 ? '+' : ''}${deviation.toFixed(1)}`;
                
                // Устанавливаем цвет отклонения
                if (deviation > 5) {
                    detailDeviationEl.className = 'result-value positive';
                } else if (deviation < -5) {
                    detailDeviationEl.className = 'result-value negative';
                } else {
                    detailDeviationEl.className = 'result-value neutral';
                }
                
                // Устанавливаем рекомендацию
                detailRecommendationTextEl.textContent = historyItem.recommendation;
                detailRecommendationEl.className = `history-recommendation ${historyItem.type}`;
                
                // Устанавливаем уверенность
                detailConfidenceBarEl.style.width = `${historyItem.confidence}%`;
                detailConfidenceValueEl.textContent = `${historyItem.confidence.toFixed(2)}%`;
                
                // Показываем ML-корректировку если есть
                if (historyItem.mlBoost && historyItem.mlBoost > 0) {
                    detailMlCorrectionEl.style.display = 'flex';
                    detailMlCorrectionValueEl.textContent = `+${historyItem.mlBoost.toFixed(2)}%`;
                    detailRecommendationEl.classList.add('ml-enhanced');
                } else {
                    detailMlCorrectionEl.style.display = 'none';
                    detailRecommendationEl.classList.remove('ml-enhanced');
                }
                
                // НОВОЕ: Заполняем секцию реальных результатов, если они есть
                if (historyItem.realScore1 !== undefined && historyItem.realScore2 !== undefined) {
                    detailRealResultsSection.style.display = 'block';
                    
                    const realTotal = historyItem.realScore1 + historyItem.realScore2;
                    const predictionError = Math.abs(historyItem.predictedTotal - realTotal);
                    const predictionAccuracy = Math.max(0, 100 - (predictionError / realTotal * 100));
                    
                    detailRealScoreEl.textContent = `${historyItem.realScore1}:${historyItem.realScore2}`;
                    detailRealTotalEl.textContent = realTotal;
                    detailPredictionErrorEl.textContent = `${predictionError.toFixed(2)} очков`;
                    detailPredictionAccuracyEl.textContent = `${predictionAccuracy.toFixed(2)}%`;
                    
                    // Определяем, была ли рекомендация правильной
                    let recommendationCorrect = false;
                    if ((historyItem.betType === 'over' && realTotal > historyItem.lineTotal) ||
                        (historyItem.betType === 'under' && realTotal < historyItem.lineTotal)) {
                        recommendationCorrect = true;
                    }
                    
                    detailRecommendationCorrectEl.textContent = recommendationCorrect ? "ПРАВИЛЬНАЯ" : "НЕПРАВИЛЬНАЯ";
                    detailRecommendationCorrectEl.className = recommendationCorrect ? "real-result-value positive" : "real-result-value negative";
                    
                    // Показываем, был ли расчет использован для обучения ML
                    detailMlTrainedEl.textContent = historyItem.mlTrained ? "Да" : "Нет";
                    detailMlTrainedEl.className = historyItem.mlTrained ? "real-result-value positive" : "real-result-value";
                } else {
                    detailRealResultsSection.style.display = 'none';
                }
                
                // НОВОЕ: Заполняем секцию обучения ML
                if (historyItem.mlTrained) {
                    detailMlTrainingSection.style.display = 'block';
                    
                    // РАСШИРЕННЫЙ РАСЧЕТ ML-СТАТИСТИКИ
                    const mlWeight = calculateMLWeight(historyItem);
                    const mlImpact = calculateMLImpact(historyItem);
                    const mlAdjustment = historyItem.mlBoost || 0;
                    
                    detailMlWeightEl.textContent = `${mlWeight.toFixed(1)}%`;
                    detailMlImpactEl.textContent = `${mlImpact > 0 ? '+' : ''}${mlImpact.toFixed(2)}%`;
                    detailMlAdjustmentEl.textContent = `${mlAdjustment > 0 ? '+' : ''}${mlAdjustment.toFixed(2)}%`;
                    detailMlStatusEl.textContent = "Обучено";
                    detailMlStatusEl.className = "training-value positive";
                } else {
                    detailMlTrainingSection.style.display = 'none';
                }
                
                // Открываем модальное окно
                historyDetailModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            // НОВАЯ ФУНКЦИЯ: Расчет веса в обучении ML
            function calculateMLWeight(historyItem) {
                if (!historyItem.mlTrained) return 0;
                
                // Базовый вес на основе уверенности
                let weight = Math.min(100, (historyItem.confidence / 30) * 100);
                
                // Увеличиваем вес для правильных прогнозов
                if (historyItem.recommendationCorrect) {
                    weight *= 1.2;
                }
                
                // Учитываем точность прогноза
                if (historyItem.predictionAccuracy) {
                    weight *= (historyItem.predictionAccuracy / 100);
                }
                
                // Учитываем давность (новые данные важнее)
                const daysAgo = (Date.now() - historyItem.id) / (1000 * 60 * 60 * 24);
                const recencyFactor = Math.max(0.5, 1 - (daysAgo / 30)); // Данные старше 30 дней имеют вес 50%
                weight *= recencyFactor;
                
                return Math.min(100, weight);
            }
            
            // НОВАЯ ФУНКЦИЯ: Расчет влияния на точность ML
            function calculateMLImpact(historyItem) {
                if (!historyItem.mlTrained) return 0;
                
                let impact = 0;
                
                // Базовое влияние на основе веса
                const weight = calculateMLWeight(historyItem);
                impact += weight * 0.1;
                
                // Влияние на основе правильности рекомендации
                if (historyItem.recommendationCorrect) {
                    impact += 2.5;
                } else {
                    impact -= 1.5;
                }
                
                // Влияние на основе точности прогноза
                if (historyItem.predictionAccuracy) {
                    impact += (historyItem.predictionAccuracy - 85) * 0.05;
                }
                
                return impact;
            }
            
            function closeHistoryDetailModal() {
                historyDetailModal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            function updateLeagueInfo() {
                let leagueName = '';
                let periodMinutes = 0;
                
                switch(currentLeague) {
                    case 'nba':
                        leagueName = 'NBA';
                        periodMinutes = 12;
                        break;
                    case 'fibа':
                        leagueName = 'ФИБА';
                        periodMinutes = 10;
                        break;
                    case 'cyber':
                        leagueName = 'Кибер';
                        periodMinutes = 5;
                        break;
                }
                
                leagueTypeEl.textContent = leagueName;
                minutesInput.max = periodMinutes;
            }
            
            function updateMLStatus() {
                if (mlData.enabled) {
                    mlStatus.classList.add('active');
                    mlTrainBtn.style.display = 'block';
                } else {
                    mlStatus.classList.remove('active');
                    mlTrainBtn.style.display = 'none';
                }
                
                // Обновляем статистику ML
                mlAccuracy.textContent = `${(mlData.accuracy * 100).toFixed(2)}%`;
                mlAdjustment.textContent = `${((mlData.adjustmentFactor - 1) * 100).toFixed(2)}%`;
                mlDataCount.textContent = mlData.totalPredictions;
                mlImprovement.textContent = `+${(mlData.accuracy * 15).toFixed(2)}%`;
                
                // Обновляем статус обучения
                if (mlData.trainedWithRealData) {
                    trainingStatusEl.textContent = "Обучена";
                    trainingStatusEl.className = "feedback-value positive";
                } else {
                    trainingStatusEl.textContent = "Не обучена";
                    trainingStatusEl.className = "feedback-value negative";
                }
            }
            
            function autoCalculate() {
                // Авторасчет при изменении данных
                const hasData = score1Input.value && score2Input.value && minutesInput.value && secondsInput.value;
                
                if (hasData) {
                    performCalculation(false);
                }
            }
            
            function performCalculation(saveToHistory = true) {
                // Получаем данные из формы
                const score1 = parseInt(score1Input.value) || 0;
                const score2 = parseInt(score2Input.value) || 0;
                const period = parseInt(periodSelect.value);
                const minutes = parseInt(minutesInput.value) || 0;
                const seconds = parseInt(secondsInput.value) || 0;
                const lineTotal = parseFloat(lineTotalInput.value) || 0;
                
                // Проверяем минимальные требования
                if (score1 === 0 && score2 === 0) {
                    showResult('Введите текущий счет матча', 'neutral', 0);
                    return;
                }
                
                // Рассчитываем прогнозируемый тотал
                const predictedTotal = calculatePredictedTotal(score1, score2, period, minutes, seconds);
                predictedTotalEl.textContent = predictedTotal.toFixed(1);
                predictedTotalEl.classList.add('success-animation');
                setTimeout(() => predictedTotalEl.classList.remove('success-animation'), 500);
                
                // Сохраняем последний прогноз для обучения ML
                lastPrediction = {
                    score1: score1,
                    score2: score2,
                    period: period,
                    minutes: minutes,
                    seconds: seconds,
                    lineTotal: lineTotal,
                    predictedTotal: predictedTotal,
                    betType: currentBetType,
                    timestamp: new Date()
                };
                
                // Сохраняем последний прогноз в localStorage
                localStorage.setItem('betAnalyzerLastPrediction', JSON.stringify(lastPrediction));
                
                // Если введен тотал букмекера, рассчитываем рекомендацию
                if (lineTotal > 0) {
                    const deviation = predictedTotal - lineTotal;
                    deviationValueEl.textContent = `${deviation > 0 ? '+' : ''}${deviation.toFixed(1)}`;
                    
                    // Определяем цвет отклонения
                    if (deviation > 5) {
                        deviationValueEl.className = 'result-value positive';
                    } else if (deviation < -5) {
                        deviationValueEl.className = 'result-value negative';
                    } else {
                        deviationValueEl.className = 'result-value neutral';
                    }
                    
                    // Рассчитываем корректировку уверенности
                    let confidenceResult = calculateConfidenceAdjustment(deviation, currentBetType);
                    
                    // Применяем ML-корректировку если включено
                    let mlBoost = 0;
                    if (mlData.enabled && mlData.totalPredictions > 5) {
                        const mlCorrectionResult = applyMLCorrection(confidenceResult, currentLeague);
                        confidenceResult.adjustment = mlCorrectionResult.adjustment;
                        mlBoost = mlCorrectionResult.mlBoost;
                        
                        // Показываем ML-бейдж и корректировку
                        mlBadge.style.display = 'block';
                        mlCorrection.style.display = 'flex';
                        mlCorrectionValue.textContent = `${mlBoost > 0 ? '+' : ''}${mlBoost.toFixed(2)}%`;
                        recommendationEl.classList.add('ml-enhanced');
                        recommendationEl.classList.add('ml-glow');
                    } else {
                        mlBadge.style.display = 'none';
                        mlCorrection.style.display = 'none';
                        recommendationEl.classList.remove('ml-enhanced');
                        recommendationEl.classList.remove('ml-glow');
                    }
                    
                    // Показываем рекомендацию
                    showResult(confidenceResult.recommendation, confidenceResult.type, confidenceResult.adjustment);
                    
                    // Сохраняем в историю если нужно
                    if (saveToHistory) {
                        saveToHistoryList(score1, score2, period, minutes, seconds, predictedTotal, lineTotal, currentBetType, confidenceResult, mlBoost);
                    }
                } else {
                    deviationValueEl.textContent = '--';
                    deviationValueEl.className = 'result-value neutral';
                    showResult('Введите тотал букмекера для получения рекомендации', 'neutral', 0);
                    mlBadge.style.display = 'none';
                    mlCorrection.style.display = 'none';
                    recommendationEl.classList.remove('ml-enhanced');
                    recommendationEl.classList.remove('ml-glow');
                }
                
                // Обновляем детали расчета
                updateCalculationDetails(score1, score2, period, minutes, seconds);
                
                // Сохраняем данные формы
                saveFormData();
            }
            
            function calculatePredictedTotal(score1, score2, period, minutes, seconds) {
                const totalScore = score1 + score2;
                
                // Определяем параметры лиги
                let minutesPerPeriod, totalPeriods, paceMultiplier;
                
                switch(currentLeague) {
                    case 'nba':
                        minutesPerPeriod = 12;
                        totalPeriods = 4;
                        paceMultiplier = 1.0;
                        break;
                    case 'fibа':
                        minutesPerPeriod = 10;
                        totalPeriods = 4;
                        paceMultiplier = 1.0;
                        break;
                    case 'cyber':
                        minutesPerPeriod = 5;
                        totalPeriods = 4;
                        paceMultiplier = 1.15;
                        break;
                }
                
                // Рассчитываем прошедшее время в минутах
                const elapsedMinutesInPeriod = minutes + seconds / 60;
                const totalElapsedMinutes = (period - 1) * minutesPerPeriod + elapsedMinutesInPeriod;
                
                // Рассчитываем оставшееся время в минутах
                const remainingMinutesInPeriod = minutesPerPeriod - elapsedMinutesInPeriod;
                const fullPeriodsRemaining = totalPeriods - period;
                const totalRemainingMinutes = remainingMinutesInPeriod + (fullPeriodsRemaining * minutesPerPeriod);
                
                // Рассчитываем текущий темп (очков в минуту)
                const currentPace = totalElapsedMinutes > 0 ? totalScore / totalElapsedMinutes : 2.0;
                
                // Прогнозируем очки на оставшееся время
                const predictedAdditionalPoints = currentPace * totalRemainingMinutes * paceMultiplier;
                
                // Итоговый прогнозируемый тотал
                return totalScore + predictedAdditionalPoints;
            }
            
            function calculateConfidenceAdjustment(deviation, betType) {
                const threshold = 5.0; // Порог значительного отклонения
                let adjustment = 0;
                let recommendation = "";
                let type = "neutral";
                
                if (betType === 'over') {
                    if (deviation > threshold) {
                        adjustment = Math.min(25, (deviation - threshold) * 0.8);
                        recommendation = "СТРОНГ ТБ ⬆️";
                        type = "strong-buy";
                    } else if (deviation > 0) {
                        adjustment = Math.min(10, deviation * 0.3);
                        recommendation = "ТБ ✅";
                        type = "buy";
                    } else {
                        adjustment = Math.max(-20, deviation * 0.4);
                        recommendation = "ИЗБЕГАТЬ ТБ ❌";
                        type = "avoid";
                    }
                } else { // under
                    if (deviation < -threshold) {
                        adjustment = Math.min(25, (Math.abs(deviation) - threshold) * 0.8);
                        recommendation = "СТРОНГ ТМ ⬇️";
                        type = "strong-buy";
                    } else if (deviation < 0) {
                        adjustment = Math.min(10, Math.abs(deviation) * 0.3);
                        recommendation = "ТМ ✅";
                        type = "buy";
                    } else {
                        adjustment = Math.max(-20, -deviation * 0.4);
                        recommendation = "ИЗБЕГАТЬ ТМ ❌";
                        type = "avoid";
                    }
                }
                
                // Округляем до двух знаков после запятой
                adjustment = Math.round(adjustment * 100) / 100;
                
                return {
                    adjustment: Math.abs(adjustment),
                    recommendation: recommendation,
                    type: type,
                    deviation: deviation
                };
            }
            
            function applyMLCorrection(confidenceResult, league) {
                // Базовый буст на основе точности ML
                let mlBoost = mlData.accuracy * 15; // До 15% буста
                
                // Корректировка на основе лиги
                if (mlData.leagueAccuracy[league]) {
                    mlBoost *= mlData.leagueAccuracy[league].factor || 1.0;
                }
                
                // Корректировка на основе недавней производительности
                if (mlData.recentPerformance.length > 0) {
                    const recentAvg = mlData.recentPerformance.reduce((a, b) => a + b, 0) / mlData.recentPerformance.length;
                    mlBoost *= (0.8 + recentAvg * 0.4); // Корректировка от 0.8x до 1.2x
                }
                
                // Применяем буст к уверенности
                const adjustedConfidence = Math.min(30, confidenceResult.adjustment + mlBoost);
                
                return {
                    adjustment: adjustedConfidence,
                    mlBoost: mlBoost
                };
            }
            
            function saveRealScore() {
                const realScore1 = parseInt(realScore1Input.value) || 0;
                const realScore2 = parseInt(realScore2Input.value) || 0;
                
                if (realScore1 === 0 && realScore2 === 0) {
                    alert('Введите реальный итоговый счет матча');
                    return;
                }
                
                // Пытаемся получить последний прогноз из localStorage, если в памяти его нет
                if (!lastPrediction) {
                    const savedLastPrediction = localStorage.getItem('betAnalyzerLastPrediction');
                    if (savedLastPrediction) {
                        lastPrediction = JSON.parse(savedLastPrediction);
                    } else {
                        alert('Сначала выполните расчет прогноза');
                        return;
                    }
                }
                
                const realTotal = realScore1 + realScore2;
                const predictionError = Math.abs(lastPrediction.predictedTotal - realTotal);
                
                // Определяем, была ли рекомендация правильной
                let recommendationCorrect = false;
                if ((lastPrediction.betType === 'over' && realTotal > lastPrediction.lineTotal) ||
                    (lastPrediction.betType === 'under' && realTotal < lastPrediction.lineTotal)) {
                    recommendationCorrect = true;
                }
                
                // Определяем точность прогноза
                const predictionAccuracy = Math.max(0, 100 - (predictionError / realTotal * 100));
                
                // Обновляем ML данные
                mlData.totalPredictions++;
                if (recommendationCorrect) {
                    mlData.correctPredictions++;
                }
                mlData.accuracy = mlData.correctPredictions / mlData.totalPredictions;
                mlData.adjustmentFactor = 1.0 + (mlData.accuracy * 0.3);
                mlData.trainedWithRealData = true;
                
                // Сохраняем производительность
                mlData.recentPerformance.push(recommendationCorrect ? 1 : 0);
                if (mlData.recentPerformance.length > 5) {
                    mlData.recentPerformance.shift();
                }
                
                // Обновляем точность для текущей лиги
                if (!mlData.leagueAccuracy[currentLeague]) {
                    mlData.leagueAccuracy[currentLeague] = { accuracy: 0, factor: 1.0 };
                }
                mlData.leagueAccuracy[currentLeague].accuracy = mlData.accuracy;
                mlData.leagueAccuracy[currentLeague].factor = 0.9 + (mlData.accuracy * 0.2);
                
                // НОВОЕ: Обновляем расширенную статистику ML
                mlData.advancedStats.totalTrainingSessions++;
                mlData.advancedStats.lastTrainingDate = new Date();
                
                // Сохраняем историю обучения
                mlData.trainingHistory.push({
                    timestamp: new Date(),
                    realScore1: realScore1,
                    realScore2: realScore2,
                    realTotal: realTotal,
                    predictionError: predictionError,
                    predictionAccuracy: predictionAccuracy,
                    recommendationCorrect: recommendationCorrect,
                    accuracyBefore: mlData.accuracy - (recommendationCorrect ? 0.01 : -0.01),
                    accuracyAfter: mlData.accuracy
                });
                
                // Обновляем обратную связь
                updateMLFeedback(predictionAccuracy, recommendationCorrect, predictionError);
                
                // Обновляем последний элемент истории реальными результатами
                if (calculationHistory.length > 0) {
                    const lastHistoryItem = calculationHistory[0];
                    lastHistoryItem.realScore1 = realScore1;
                    lastHistoryItem.realScore2 = realScore2;
                    lastHistoryItem.realTotal = realTotal;
                    lastHistoryItem.predictionError = predictionError;
                    lastHistoryItem.predictionAccuracy = predictionAccuracy;
                    lastHistoryItem.recommendationCorrect = recommendationCorrect;
                    lastHistoryItem.mlTrained = true;
                    
                    // Перерисовываем историю
                    renderHistory();
                    saveHistory();
                }
                
                saveMLData();
                updateMLStatus();
                
                // Сохраняем реальный счет
                const realScoreData = {
                    score1: realScore1,
                    score2: realScore2,
                    timestamp: Date.now()
                };
                localStorage.setItem('betAnalyzerRealScore', JSON.stringify(realScoreData));
                
                realScoreSaved = true;
                updateRealScoreUI();
                
                // Показываем сообщение об успехе
                realScoreSuccess.style.display = 'flex';
                realScoreSuccess.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>Реальный счет сохранен! Точность прогноза: ${predictionAccuracy.toFixed(2)}%</span>
                `;
                
                // Сохраняем обновленные данные формы
                saveFormData();
                
                // Автоматически запускаем обучение ML, если есть достаточно данных
                if (calculationHistory.filter(item => item.realTotal !== undefined).length >= 3) {
                    setTimeout(() => {
                        trainMLModel();
                    }, 1000);
                }
            }
            
            function updateMLFeedback(predictionAccuracy, recommendationCorrect, predictionError) {
                predictionAccuracyEl.textContent = `${predictionAccuracy.toFixed(2)}%`;
                if (predictionAccuracy >= 90) {
                    predictionAccuracyEl.className = "feedback-value positive";
                } else if (predictionAccuracy >= 80) {
                    predictionAccuracyEl.className = "feedback-value";
                } else {
                    predictionAccuracyEl.className = "feedback-value negative";
                }
                
                recommendationAccuracyEl.textContent = recommendationCorrect ? "ПРАВИЛЬНАЯ" : "НЕПРАВИЛЬНАЯ";
                recommendationAccuracyEl.className = recommendationCorrect ? "feedback-value positive" : "feedback-value negative";
                
                predictionErrorEl.textContent = `${predictionError.toFixed(2)} очков`;
                if (predictionError <= 5) {
                    predictionErrorEl.className = "feedback-value positive";
                } else if (predictionError <= 10) {
                    predictionErrorEl.className = "feedback-value";
                } else {
                    predictionErrorEl.className = "feedback-value negative";
                }
            }
            
            function trainMLModel() {
                if (calculationHistory.length < 3) {
                    alert('Нужно как минимум 3 расчета в истории для обучения ML модели');
                    return;
                }
                
                if (!mlData.trainedWithRealData) {
                    alert('Для обучения ML модели необходимо сохранить реальные результаты матчей');
                    return;
                }
                
                // РЕАЛЬНОЕ ОБУЧЕНИЕ ML МОДЕЛИ
                const trainingData = calculationHistory.filter(item => item.realTotal !== undefined);
                
                if (trainingData.length < 3) {
                    alert('Нужно как минимум 3 расчета с реальными результатами для обучения ML модели');
                    return;
                }
                
                // Рассчитываем точность на основе реальных результатов
                let totalError = 0;
                let correctPredictions = 0;
                
                trainingData.forEach(item => {
                    const error = Math.abs(item.predictedTotal - item.realTotal);
                    totalError += error;
                    
                    // Считаем прогноз "правильным" если отклонение было в правильном направлении
                    if ((item.betType === 'over' && item.predictedTotal > item.lineTotal) ||
                        (item.betType === 'under' && item.predictedTotal < item.lineTotal)) {
                        correctPredictions++;
                    }
                });
                
                const avgError = totalError / trainingData.length;
                const accuracy = correctPredictions / trainingData.length;
                
                // ОБНОВЛЯЕМ ML ДАННЫЕ С РЕАЛЬНЫМ ОБУЧЕНИЕМ
                mlData.accuracy = accuracy;
                mlData.totalPredictions = trainingData.length;
                mlData.correctPredictions = correctPredictions;
                mlData.adjustmentFactor = 1.0 + (accuracy * 0.3); // До 30% коррекции
                
                // Сохраняем производительность
                mlData.recentPerformance.push(accuracy);
                if (mlData.recentPerformance.length > 5) {
                    mlData.recentPerformance.shift();
                }
                
                // Обновляем точность для текущей лиги
                if (!mlData.leagueAccuracy[currentLeague]) {
                    mlData.leagueAccuracy[currentLeague] = { accuracy: 0, factor: 1.0 };
                }
                mlData.leagueAccuracy[currentLeague].accuracy = accuracy;
                mlData.leagueAccuracy[currentLeague].factor = 0.9 + (accuracy * 0.2);
                
                // НОВОЕ: Обновляем расширенную статистику ML
                mlData.advancedStats.totalTrainingSessions++;
                mlData.advancedStats.lastTrainingDate = new Date();
                mlData.advancedStats.modelVersion = "1." + mlData.advancedStats.totalTrainingSessions;
                
                // НОВОЕ: Обновляем ML-статистику для всех элементов истории
                calculationHistory.forEach(item => {
                    if (item.realTotal !== undefined) {
                        item.mlTrained = true;
                    }
                });
                
                saveMLData();
                updateMLStatus();
                
                // Перерисовываем историю с обновленными данными
                renderHistory();
                saveHistory();
                
                // Показываем результат обучения
                alert(`🎓 ML модель обучена!\n\n📊 Точность: ${(accuracy * 100).toFixed(2)}%\n📈 Средняя ошибка: ${avgError.toFixed(2)} очков\n⚡ Корректировка: +${((mlData.adjustmentFactor - 1) * 100).toFixed(2)}%\n\n🤖 Модель v${mlData.advancedStats.modelVersion} готова к работе!`);
                
                // Пересчитываем текущий прогноз с обновленной ML моделью
                autoCalculate();
            }
            
            function showResult(recommendation, type, confidence) {
                recommendationTextEl.textContent = recommendation;
                recommendationEl.className = `recommendation ${type}`;
                confidenceBarEl.style.width = `${confidence}%`;
                confidenceValueEl.textContent = `${confidence.toFixed(2)}%`;
                
                // Анимация для рекомендации
                recommendationEl.classList.add('success-animation');
                setTimeout(() => recommendationEl.classList.remove('success-animation'), 500);
            }
            
            function updateCalculationDetails(score1, score2, period, minutes, seconds) {
                const totalScore = score1 + score2;
                
                // Определяем параметры лиги
                let minutesPerPeriod;
                switch(currentLeague) {
                    case 'nba': minutesPerPeriod = 12; break;
                    case 'fibа': minutesPerPeriod = 10; break;
                    case 'cyber': minutesPerPeriod = 5; break;
                }
                
                // Рассчитываем прошедшее время в минутах
                const elapsedMinutesInPeriod = minutes + seconds / 60;
                const totalElapsedMinutes = (period - 1) * minutesPerPeriod + elapsedMinutesInPeriod;
                
                // Рассчитываем оставшееся время в минутах
                const remainingMinutesInPeriod = minutesPerPeriod - elapsedMinutesInPeriod;
                const fullPeriodsRemaining = 4 - period;
                const totalRemainingMinutes = remainingMinutesInPeriod + (fullPeriodsRemaining * minutesPerPeriod);
                
                // Рассчитываем текущий темп (очков в минуту)
                const currentPace = totalElapsedMinutes > 0 ? totalScore / totalElapsedMinutes : 0;
                
                // Обновляем детали
                paceValueEl.textContent = `${currentPace.toFixed(2)} оч/мин`;
                timeLeftEl.textContent = `${totalRemainingMinutes.toFixed(2)} мин`;
                thresholdValueEl.textContent = "5.0 оч";
            }
            
            function saveToHistoryList(score1, score2, period, minutes, seconds, predictedTotal, lineTotal, betType, confidenceResult, mlBoost) {
                const historyItem = {
                    id: Date.now(),
                    score: `${score1}:${score2}`,
                    period: period,
                    minutes: minutes,
                    seconds: seconds,
                    league: currentLeague,
                    predictedTotal: predictedTotal,
                    lineTotal: lineTotal,
                    betType: betType,
                    recommendation: confidenceResult.recommendation,
                    confidence: confidenceResult.adjustment,
                    type: confidenceResult.type,
                    mlBoost: mlBoost || 0,
                    mlEnhanced: mlData.enabled && mlData.totalPredictions > 5,
                    mlTrained: false, // По умолчанию не обучено
                    timestamp: new Date().toLocaleTimeString()
                };
                
                calculationHistory.unshift(historyItem);
                if (calculationHistory.length > 10) {
                    calculationHistory = calculationHistory.slice(0, 10);
                }
                
                saveHistory();
                renderHistory();
            }
            
            function renderHistory() {
                historyListEl.innerHTML = '';
                
                if (calculationHistory.length === 0) {
                    historyListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">История расчетов пуста</div>';
                    return;
                }
                
                calculationHistory.forEach(item => {
                    const historyItemEl = document.createElement('div');
                    historyItemEl.className = item.realScore1 !== undefined ? 'history-item history-item-with-real' : 'history-item';
                    
                    const confidenceClass = item.mlEnhanced ? 'ml-enhanced' : 
                                          item.confidence > 10 ? 'positive' : 
                                          item.confidence > 5 ? 'neutral' : 'negative';
                    
                    historyItemEl.innerHTML = `
                        <div style="flex: 1;">
                            <div class="history-prediction">${item.score} | ${item.recommendation} ${item.mlEnhanced ? '🤖' : ''} ${item.realScore1 !== undefined ? '✅' : ''}</div>
                            <div class="history-details">Прогноз: ${item.predictedTotal.toFixed(1)} vs Линия: ${item.lineTotal}</div>
                        </div>
                        <div class="history-confidence ${confidenceClass}">${item.confidence.toFixed(2)}%</div>
                    `;
                    
                    // Добавляем обработчик клика для открытия деталей
                    historyItemEl.addEventListener('click', function() {
                        openHistoryDetailModal(item);
                    });
                    
                    historyListEl.appendChild(historyItemEl);
                });
            }
            
            function saveHistory() {
                localStorage.setItem('betAnalyzerHistory', JSON.stringify(calculationHistory));
            }
            
            function loadHistory() {
                const savedHistory = localStorage.getItem('betAnalyzerHistory');
                if (savedHistory) {
                    calculationHistory = JSON.parse(savedHistory);
                    renderHistory();
                }
            }
            
            function saveMLData() {
                localStorage.setItem('betAnalyzerMLData', JSON.stringify(mlData));
            }
            
            function loadMLData() {
                const savedMLData = localStorage.getItem('betAnalyzerMLData');
                if (savedMLData) {
                    mlData = JSON.parse(savedMLData);
                    mlToggle.checked = mlData.enabled;
                    updateMLStatus();
                }
            }
            
            function clearForm() {
                score1Input.value = '';
                score2Input.value = '';
                minutesInput.value = '';
                secondsInput.value = '';
                lineTotalInput.value = '';
                realScore1Input.value = '';
                realScore2Input.value = '';
                
                predictedTotalEl.textContent = '--';
                deviationValueEl.textContent = '--';
                deviationValueEl.className = 'result-value neutral';
                
                showResult('Введите данные для расчета', 'neutral', 0);
                
                paceValueEl.textContent = '-- оч/мин';
                timeLeftEl.textContent = '-- мин';
                
                mlBadge.style.display = 'none';
                mlCorrection.style.display = 'none';
                recommendationEl.classList.remove('ml-enhanced');
                recommendationEl.classList.remove('ml-glow');
                
                // Сбрасываем обратную связь ML
                predictionAccuracyEl.textContent = '--';
                predictionAccuracyEl.className = 'feedback-value neutral';
                recommendationAccuracyEl.textContent = '--';
                recommendationAccuracyEl.className = 'feedback-value neutral';
                predictionErrorEl.textContent = '--';
                predictionErrorEl.className = 'feedback-value neutral';
                
                // Очищаем сохраненные данные формы
                localStorage.removeItem('betAnalyzerFormData');
                savedDataNotice.style.display = 'none';
                
                // Закрываем клавиатуру если открыта
                hideCustomKeyboard();
            }
            
            // Инициализация информации о лиге
            updateLeagueInfo();
        });
    </script>
</body>
</html>
