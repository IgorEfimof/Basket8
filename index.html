<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon203.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSK8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Баскетбол. Калькулятор тотала</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary-color: #fdbb2d;
            --secondary-color: #1a2a6c;
            --background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            --container-bg: rgba(0, 0, 0, 0.7);
            --text-color: #fff;
            --card-bg: rgba(30, 30, 50, 0.8);
            --input-bg: rgba(255, 255, 255, 0.9);
            --input-color: #333;
            --stats-bg: rgba(40, 40, 60, 0.6);
            --positive-color: #4caf50;
            --negative-color: #f44336;
            --neutral-color: #2196f3;
            --men-color: #3498db;
            --women-color: #e91e63;
        }

        /* Светлая тема (солнце) */
        .theme-light {
            --primary-color: #1a2a6c;
            --secondary-color: #fdbb2d;
            --background: linear-gradient(135deg, #fdbb2d, #b21f1f, #1a2a6c);
            --container-bg: rgba(255, 255, 255, 0.9);
            --text-color: #333;
            --card-bg: rgba(240, 240, 240, 0.9);
            --input-bg: rgba(255, 255, 255, 0.9);
            --input-color: #333;
            --stats-bg: rgba(220, 220, 220, 0.6);
        }

        /* Темная тема (луна) */
        .theme-dark {
            --primary-color: #fdbb2d;
            --secondary-color: #1a2a6c;
            --background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            --container-bg: rgba(0, 0, 0, 0.7);
            --text-color: #fff;
            --card-bg: rgba(30, 30, 50, 0.8);
            --input-bg: rgba(255, 255, 255, 0.9);
            --input-color: #333;
            --stats-bg: rgba(40, 40, 60, 0.6);
        }

        /* Серо-голубая тема (полнолуние) */
        .theme-moon {
            --primary-color: #9c88ff;
            --secondary-color: #192a56;
            --background: linear-gradient(135deg, #192a56, #273c75, #487eb0);
            --container-bg: rgba(25, 42, 86, 0.8);
            --text-color: #fff;
            --card-bg: rgba(39, 60, 117, 0.8);
            --input-bg: rgba(255, 255, 255, 0.9);
            --input-color: #333;
            --stats-bg: rgba(72, 126, 176, 0.6);
        }
        
        body {
            background: var(--background);
            color: var(--text-color);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            transition: background 0.5s ease;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 0;
            padding: 15px;
            box-shadow: none;
            transition: background 0.5s ease;
        }
        
        .header-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .control-select {
            flex: 1;
            margin: 0 5px;
        }
        
        select {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: var(--input-bg);
            color: var(--input-color);
            font-size: 0.85rem;
        }
        
        header {
            text-align: center;
            padding: 15px 0;
            margin-bottom: 10px;
            position: relative;
        }
        
        h1 {
            font-size: 1.4rem;
            margin-bottom: 8px;
            color: var(--primary-color);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .championship-info {
            text-align: center;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .input-section {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 12px;
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 12px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 6px;
            font-size: 1.1rem;
        }
        
        .form-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: var(--input-bg);
            color: var(--input-color);
            font-size: 0.85rem;
        }
        
        button {
            width: 100%;
            padding: 10px;
            background: var(--primary-color);
            color: var(--secondary-color);
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 8px;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .clear-btn {
            background: #ff6b6b;
            color: white;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .result-section {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        @media (min-width: 480px) {
            .result-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .result-card.full-width {
                grid-column: 1 / -1;
            }
        }
        
        .result-card {
            background: rgba(40, 40, 60, 0.9);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .result-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .result-value {
            font-size: 0.9rem;
            text-align: center;
            padding: 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            margin-top: 4px;
        }
        
        .positive {
            color: var(--positive-color);
        }
        
        .negative {
            color: var(--negative-color);
        }
        
        .neutral {
            color: var(--neutral-color);
        }
        
        footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 12px;
            color: var(--text-color);
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        .period-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .period-btn {
            flex: 1;
            margin: 0 3px 5px 3px;
            padding: 5px;
            background: #3949ab;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75rem;
            min-width: 50px;
        }
        
        .period-btn.active {
            background: var(--primary-color);
            color: var(--secondary-color);
        }
        
        .custom-keyboard {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #333;
            padding: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .keyboard-row {
            display: flex;
            justify-content: center;
            margin-bottom: 3px;
        }
        
        .keyboard-key {
            flex: 1;
            height: 40px;
            margin: 1px;
            background: #fff;
            color: #333;
            border: none;
            border-radius: 3px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }
        
        .keyboard-key-wide {
            flex: 2;
        }
        
        .keyboard-close {
            background: #4caf50;
            color: white;
            font-size: 0.9rem;
        }
        
        .keyboard-backspace {
            background: #f44336;
            color: white;
            font-size: 0.9rem;
        }
        
        .keyboard-symbol {
            background: #ddd;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .data-item {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .data-label {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        
        .data-value {
            font-size: 1rem;
            font-weight: bold;
        }
        
        .time-display {
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            display: inline-block;
            margin-top: 8px;
            cursor: pointer;
            text-align: center;
            width: 100%;
        }
        
        input:focus, select:focus {
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .input-active {
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        @media (min-width: 768px) {
            .container {
                padding: 15px;
                border-radius: 12px;
                margin: 10px auto;
                max-width: 600px;
            }
        }
        
        body {
            touch-action: manipulation;
        }
        
        .moon-phase-display, .day-factor-display, .fatigue-factor-display {
            font-size: 0.8rem;
            margin-top: 4px;
            font-style: italic;
            padding: 4px 0;
        }
        
        .moon-icon {
            margin-right: 5px;
            font-size: 0.9rem;
        }
        
        .day-icon, .fatigue-icon {
            margin-right: 5px;
            font-size: 0.9rem;
        }
        
        .factor-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        .factor-name {
            font-weight: bold;
        }
        
        .factor-value {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .factor-positive {
            color: var(--positive-color);
        }
        
        .factor-negative {
            color: var(--negative-color);
        }
        
        .factor-neutral {
            color: var(--neutral-color);
        }
        
        .gender-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 5px;
        }
        
        .gender-icon {
            font-size: 1rem;
        }
        
        .theme-switcher {
            display: flex;
            justify-content: center;
            margin: 10px 0 15px 0;
        }
        
        .theme-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 8px;
            border: 2px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .theme-btn.active {
            border-color: var(--primary-color);
            transform: scale(1.1);
        }
        
        .theme-btn.sun {
            background: linear-gradient(135deg, #ffcc00, #ff9900);
            color: #fff;
        }
        
        .theme-btn.moon {
            background: linear-gradient(135deg, #666, #333);
            color: #fff;
        }
        
        .theme-btn.full-moon {
            background: linear-gradient(135deg, #9c88ff, #487eb0);
            color: #fff;
        }
    </style>
</head>
<body class="theme-dark">
    <div class="container">
        <div class="header-controls">
            <div class="control-select">
                <select id="championship-select">
                    <option value="nba">NBA (4×12 мин)</option>
                    <option value="fiba">ФИБА (4×10 мин)</option>
                    <option value="three3">3×3 (4×10 мин)</option>
                    <option value="three3_12min">3×3 (4×12 мин)</option>
                    <option value="four4">4×4 (2×10 мин)</option>
                    <option value="cyber">Кибербаскетбол (4×5 мин)</option>
                    <option value="cyber4">Кибербаскетбол (4×4 мин)</option>
                </select>
            </div>
            <div class="control-select">
                <select id="gender-select">
                    <option value="men">Мужчины</option>
                    <option value="women">Женщины</option>
                </select>
            </div>
        </div>
        
        <div class="theme-switcher">
            <div class="theme-btn sun active" data-theme="light">
                <i class="fas fa-sun"></i>
            </div>
            <div class="theme-btn moon" data-theme="dark">
                <i class="fas fa-moon"></i>
            </div>
            <div class="theme-btn full-moon" data-theme="moon">
                <i class="fas fa-star"></i>
            </div>
        </div>
        
        <header>
            <h1>Баскетбол. Калькулятор тотала</h1>
            <div class="match-details">
                Быстрый расчет общего количества очков в матче
            </div>
        </header>
        
        <div class="championship-info" id="championship-info">
            Формат: NBA - 4 периода по 12 минут
        </div>
        
        <div class="time-display" id="match-time-editable">
            3-я четверть, 5:00
        </div>
        
        <div class="data-grid">
            <div class="data-item">
                <div class="data-label">Текущий период</div>
                <div class="data-value" id="period-display">3-й</div>
            </div>
            <div class="data-item">
                <div class="data-label">Оставшееся время</div>
                <div class="data-value" id="time-display">5:00</div>
            </div>
            <div class="data-item">
                <div class="data-label">Общий тотал</div>
                <div class="data-value" id="total-display">143</div>
            </div>
            <div class="data-item">
                <div class="data-label">Темп игры</div>
                <div class="data-value" id="pace-display">--</div>
            </div>
        </div>
        
        <div class="input-section">
            <h2>Ввод данных</h2>
            
            <div class="form-columns">
                <div class="form-column">
                    <div class="form-group">
                        <label for="current-period">Текущий период:</label>
                        <select id="current-period">
                            <option value="1">1-й период</option>
                            <option value="2">2-й период</option>
                            <option value="3" selected>3-й период</option>
                            <option value="4">4-й период</option>
                            <option value="ot">Овертайм</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="time-remaining">Оставшееся время:</label>
                        <input type="text" id="time-remaining" placeholder="Мин:сек" value="5:00" inputmode="none" readonly>
                    </div>
                </div>
                
                <div class="form-column">
                    <div class="form-group">
                        <label for="total-points">Общее количество очков:</label>
                        <input type="text" id="total-points" value="143" inputmode="none" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="avg-points">Ср. очки за период:</label>
                        <input type="text" id="avg-points" value="45" placeholder="40-50" inputmode="none" readonly>
                    </div>
                </div>
            </div>
            
            <div class="period-controls">
                <button class="period-btn active" data-period="1">1-й</button>
                <button class="period-btn" data-period="2">2-й</button>
                <button class="period-btn" data-period="3">3-й</button>
                <button class="period-btn" data-period="4">4-й</button>
            </div>
        </div>
        
        <div class="result-section">
            <h2>Результаты расчета</h2>
            <div class="result-grid">
                <div class="result-card">
                    <div class="result-title">Прогноз тотала матча:</div>
                    <div class="result-value" id="predicted-total">--</div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">Темп игры:</div>
                    <div class="result-value" id="game-pace">--</div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">Прогноз на конец периода:</div>
                    <div class="result-value" id="period-prediction">--</div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">Рекомендация по тоталу:</div>
                    <div class="result-value" id="total-recommendation">--</div>
                </div>
                
                <div class="result-card full-width">
                    <div class="result-title">Факторы влияния на прогноз:</div>
                    <div class="result-value" id="time-impact">--</div>
                    
                    <div class="factor-display">
                        <div class="factor-name">
                            <i class="fas fa-moon moon-icon"></i>Фаза Луны:
                        </div>
                        <div class="factor-value" id="moon-factor">--</div>
                    </div>
                    
                    <div class="factor-display">
                        <div class="factor-name">
                            <i class="fas fa-calendar-day day-icon"></i>День недели:
                        </div>
                        <div class="factor-value" id="day-factor">--</div>
                    </div>
                    
                    <div class="factor-display">
                        <div class="factor-name">
                            <i class="fas fa-clock fatigue-icon"></i>Усталость команд:
                        </div>
                        <div class="factor-value" id="fatigue-factor">--</div>
                    </div>
                    
                    <div class="gender-display">
                        <i class="fas fa-venus-mars gender-icon"></i>
                        <div class="gender-name" id="gender-factor">--</div>
                    </div>
                </div>
            </div>
        </div>
        
        <button class="clear-btn" id="clear-btn">
            <i class="fas fa-trash-alt"></i> Очистить все данные
        </button>
        
        <footer>
            <p>Простой калькулятор для расчета баскетбольного тотала.</p>
            <p>Ответственность за решения лежит на вас.</p>
        </footer>
    </div>

    <!-- Обновленная кастомная клавиатура -->
    <div class="custom-keyboard" id="custom-keyboard">
        <div class="keyboard-row">
            <button class="keyboard-key" data-key="1">1</button>
            <button class="keyboard-key" data-key="2">2</button>
            <button class="keyboard-key" data-key="3">3</button>
            <button class="keyboard-key" data-key="4">4</button>
            <button class="keyboard-key" data-key="5">5</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key" data-key="6">6</button>
            <button class="keyboard-key" data-key="7">7</button>
            <button class="keyboard-key" data-key="8">8</button>
            <button class="keyboard-key" data-key="9">9</button>
            <button class="keyboard-key" data-key="0">0</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key keyboard-symbol" data-key=":">:</button>
            <button class="keyboard-key keyboard-symbol" data-key=".">.</button>
            <button class="keyboard-key keyboard-symbol" data-key=",">,</button>
            <button class="keyboard-key keyboard-backspace" id="keyboard-backspace">
                <i class="fas fa-backspace"></i>
            </button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-key keyboard-close keyboard-key-wide" id="keyboard-close">Готово</button>
        </div>
    </div>

    <script>
        // Обновленная конфигурация чемпионатов с реалистичными средними значениями
        const championships = {
            'nba': { 
                name: 'NBA (4×12 мин)', 
                periods: 4, 
                periodLength: 12, 
                otLength: 5, 
                description: '4 периода по 12 минут, овертайм 5 минут',
                avgPoints: 55
            },
            'fiba': { 
                name: 'ФИБА (4×10 мин)', 
                periods: 4, 
                periodLength: 10, 
                otLength: 5, 
                description: '4 периода по 10 минут, овертайм 5 минут',
                avgPoints: 45
            },
            'three3': { 
                name: '3×3 (4×10 мин)', 
                periods: 4, 
                periodLength: 10, 
                otLength: 2, 
                description: '3 на 3, 4 периода по 10 минут, овертайм 2 минуты',
                avgPoints: 35
            },
            'three3_12min': { 
                name: '3×3 (4×12 мин)', 
                periods: 4, 
                periodLength: 12, 
                otLength: 2, 
                description: '3 на 3, 4 периода по 12 минут, овертайм 2 минуты',
                avgPoints: 40
            },
            'four4': { 
                name: '4×4 (2×10 мин)', 
                periods: 2, 
                periodLength: 10, 
                otLength: 5, 
                description: '4 на 4, 2 периода по 10 минут, овертайм 5 минут',
                avgPoints: 50
            },
            'cyber': { 
                name: 'Кибербаскетбол (4×5 мин)', 
                periods: 4, 
                periodLength: 5, 
                otLength: 2, 
                description: '4 периода по 5 минут, овертайм 2 минуты',
                avgPoints: 25
            },
            'cyber4': { 
                name: 'Кибербаскетбол (4×4 мин)', 
                periods: 4, 
                periodLength: 4, 
                otLength: 2, 
                description: '4 периода по 4 минуты, овертайм 2 минуты',
                avgPoints: 20
            }
        };

        // Коэффициенты влияния дней недели (обновленные)
        const dayFactors = {
            0: { name: "Воскресенье", factor: 1.08, description: "Выходной - высокая активность" },
            1: { name: "Понедельник", factor: 0.92, description: "Начало недели - низкая активность" },
            2: { name: "Вторник", factor: 1.0, description: "Средняя активность" },
            3: { name: "Среда", factor: 1.03, description: "Средняя активность" },
            4: { name: "Четверг", factor: 1.06, description: "Повышенная активность" },
            5: { name: "Пятница", factor: 1.12, description: "Конец недели - высокая активность" },
            6: { name: "Суббота", factor: 1.1, description: "Выходной - высокая активность" }
        };

        // ОБНОВЛЕННЫЕ коэффициенты усталости по времени суток (на основе статистики)
        const fatigueFactors = {
            'morning': { name: "Утро (6:00-12:00)", factor: 1.05, description: "Свежие команды - высокая эффективность" },
            'afternoon': { name: "День (12:00-18:00)", factor: 1.0, description: "Стандартная эффективность" },
            'early_evening': { name: "Ранний вечер (18:00-21:00)", factor: 0.98, description: "Легкая усталость - небольшое снижение" },
            'late_evening': { name: "Поздний вечер (21:00-24:00)", factor: 0.92, description: "Значительная усталость - заметное снижение" },
            'night': { name: "Ночь (0:00-6:00)", factor: 0.85, description: "Сильная усталость - низкая эффективность" }
        };

        // Текущий выбранный чемпионат
        let currentChampionship = 'nba';
        
        // Текущий выбранный пол
        let currentGender = 'men';
        
        // Глобальные переменные для хранения данных анализа
        let currentMoonPhase = 0;
        let currentMoonInfluence = { influence: 1, note: "" };
        
        // Глобальные переменные для хранения данных ввода
        let activeInput = null;
        const keyboard = document.getElementById('custom-keyboard');
        
        // Функция для определения временного интервала (ОБНОВЛЕННАЯ)
        function getTimeInterval(hours) {
            if (hours >= 6 && hours < 12) return 'morning';
            if (hours >= 12 && hours < 18) return 'afternoon';
            if (hours >= 18 && hours < 21) return 'early_evening';
            if (hours >= 21 && hours < 24) return 'late_evening';
            return 'night';
        }
        
        // Функция для расчета текущей фазы Луны
        function calculateMoonPhase(date) {
            // Известная эпоха: 6 января 2000 года 18:14 UTC (полнолуние)
            const knownFullMoon = new Date(Date.UTC(2000, 0, 6, 18, 14, 0));
            const lunarCycle = 29.530588853; // дней в лунном цикле
            
            // Вычисляем разницу в днями
            const diffInMs = date - knownFullMoon;
            const diffInDays = diffInMs / (1000 * 60 * 60 * 24);
            
            // Вычисляем текущую фазу
            let phase = (diffInDays % lunarCycle) / lunarCycle;
            if (phase < 0) phase += 1; // нормализуем от 0 до 1
            
            return phase;
        }
        
        // Функция для определения названия фазы Луны
        function getMoonPhaseName(phase) {
            if (phase < 0.03 || phase >= 0.97) return "Новолуние";
            if (phase < 0.22) return "Растущая луна";
            if (phase < 0.28) return "Первая четверть";
            if (phase < 0.47) return "Прибывающая луна";
            if (phase < 0.53) return "Полнолуние";
            if (phase < 0.72) return "Убывающая луна";
            if (phase < 0.78) return "Последняя четверть";
            return "Стареющая луна";
        }
        
        // Функция для расчета влияния Луны на команды
        function calculateMoonInfluence(moonPhase, gender) {
            let influence = 1.0;
            let note = "";
            
            // Определяем, является ли фаза особенной
            const isNewMoon = moonPhase < 0.03 || moonPhase >= 0.97;
            const isFullMoon = moonPhase >= 0.47 && moonPhase < 0.53;
            const isQuarterMoon = (moonPhase >= 0.22 && moonPhase < 0.28) || (moonPhase >= 0.72 && moonPhase < 0.78);
            
            if (isFullMoon) {
                if (gender === 'men') {
                    influence = 1.08; // +8% к эффективности для мужчин в полнолуние
                    note = "Полнолуние: повышение агрессии и результативности у мужских команд";
                } else {
                    influence = 1.05; // +5% к эффективности для женщин в полнолуние
                    note = "Полнолуние: улучшение точности бросков у женских команд";
                }
            } else if (isNewMoon) {
                influence = 0.95; // -5% к эффективности в новолуние
                note = "Новолуние: снижение эффективности для всех";
            } else if (isQuarterMoon) {
                influence = 1.02; // +2% к эффективности в четверти
                note = "Фаза четверти: небольшое повышение активности";
            } else {
                note = "Нормальное лунное влияние";
            }
            
            return { influence, note };
        }

        // Функция для установки средних очков при смене лиги
        function setDefaultAvgPoints() {
            const champ = championships[currentChampionship];
            const avgPoints = champ.avgPoints;
            document.getElementById('avg-points').value = avgPoints;
        }

        // Обновление текущего времени
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ru-RU');
            // В упрощенной версии не показываем время
        }
        
        // Обновляем время каждую секунду
        setInterval(updateTime, 1000);
        updateTime(); // initial call
        
        // Обработчики для выбора чемпионата и пола
        document.getElementById('championship-select').addEventListener('change', function() {
            currentChampionship = this.value;
            const champ = championships[currentChampionship];
            document.getElementById('championship-info').textContent = `Формат: ${champ.description}`;
            setDefaultAvgPoints();
            calculatePredictions();
        });
        
        document.getElementById('gender-select').addEventListener('change', function() {
            currentGender = this.value;
            calculatePredictions();
        });
        
        // Обработчики для переключения тем
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const theme = this.getAttribute('data-theme');
                document.body.className = `theme-${theme}`;
                
                // Обновляем активную кнопку
                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Предотвращаем появление системной клавиатуры
        document.addEventListener('touchstart', function(e) {
            if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Обработчики для полей ввода - показ кастомной клавиатуры
        const inputFields = document.querySelectorAll('input');
        inputFields.forEach(input => {
            input.addEventListener('focus', function(e) {
                e.preventDefault();
                activeInput = this;
                keyboard.style.display = 'block';
                
                // Добавляем класс для выделения активного поля
                inputFields.forEach(field => field.classList.remove('input-active'));
                this.classList.add('input-active');
                
                // Предотвращаем появление системной клавиатуры
                this.blur();
            });
        });
        
        // Обработчик для редактирования времени матча
        document.getElementById('match-time-editable').addEventListener('click', function(e) {
            e.preventDefault();
            const currentValue = this.textContent;
            
            // Создаем временное поле ввода
            const tempInput = document.createElement('input');
            tempInput.type = 'text';
            tempInput.value = currentValue;
            tempInput.classList.add('stat-input');
            tempInput.style.fontSize = '1rem';
            tempInput.style.textAlign = 'center';
            tempInput.style.width = '100%';
            tempInput.style.background = 'transparent';
            tempInput.style.color = 'inherit';
            tempInput.style.border = '1px dashed var(--primary-color)';
            
            // Заменяем содержимое на поле ввода
            this.innerHTML = '';
            this.appendChild(tempInput);
            
            // Показываем кастомную клавиатуру
            keyboard.style.display = 'block';
            
            // Обработчик завершения редактирования
            const finishEdit = () => {
                const newValue = tempInput.value;
                this.innerHTML = newValue;
                
                // Парсим введенные данные
                const match = newValue.match(/(\d+)-я (четверть|тайм), (\d+):(\d+)/);
                if (match) {
                    const period = match[1];
                    const minutes = match[3];
                    const seconds = match[4];
                    
                    // Обновляем поля ввода
                    document.getElementById('current-period').value = period;
                    document.getElementById('time-remaining').value = `${minutes}:${seconds}`;
                    
                    // Обновляем отображение данных
                    updateDataDisplay();
                    
                    // Активируем соответствующую кнопку периода
                    document.querySelectorAll('.period-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.period === period) {
                            btn.classList.add('active');
                        }
                    });
                    
                    // Пересчитываем прогнозы
                    calculatePredictions();
                }
                
                keyboard.style.display = 'none';
            };
            
            // Обработчик для кнопки "Готово"
            const finishHandler = () => {
                finishEdit();
                document.getElementById('keyboard-close').removeEventListener('click', finishHandler);
            };
            
            document.getElementById('keyboard-close').addEventListener('click', finishHandler);
        });
        
        // Функция обновления отображения данных
        function updateDataDisplay() {
            const period = document.getElementById('current-period').value;
            let periodText;
            if (period === 'ot') {
                periodText = 'Овертайм';
            } else {
                periodText = period + '-й период';
            }
            document.getElementById('period-display').textContent = periodText;
            
            document.getElementById('time-display').textContent = document.getElementById('time-remaining').value || '--';
            
            const totalPoints = document.getElementById('total-points').value || '--';
            document.getElementById('total-display').textContent = totalPoints;
        }
        
        // Обработчики для кнопок клавиатуры
        document.querySelectorAll('.keyboard-key[data-key]').forEach(button => {
            button.addEventListener('click', function() {
                const key = this.getAttribute('data-key');
                
                if (activeInput) {
                    activeInput.value += key;
                    updateDataDisplay();
                    calculatePredictions(); // Автоматический расчет
                }
            });
        });
        
        // Обработчик для backspace
        document.getElementById('keyboard-backspace').addEventListener('click', function() {
            if (activeInput) {
                activeInput.value = activeInput.value.slice(0, -1);
                updateDataDisplay();
                calculatePredictions(); // Автоматический расчет
            }
        });
        
        // Обработчик для закрытия клавиатуры
        document.getElementById('keyboard-close').addEventListener('click', function() {
            keyboard.style.display = 'none';
            if (activeInput) {
                activeInput.classList.remove('input-active');
                activeInput = null;
            }
        });
        
        // Обработчики кнопок периодов
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('current-period').value = this.dataset.period;
                updateMatchTimeDisplay();
                updateDataDisplay();
                calculatePredictions();
            });
        });
        
        // Обработчик кнопки очистки
        document.getElementById('clear-btn').addEventListener('click', function() {
            if (confirm('Вы уверены, что хотите очистить все данные?')) {
                // Очищаем поля ввода
                document.getElementById('time-remaining').value = '';
                document.getElementById('total-points').value = '';
                setDefaultAvgPoints();

                // Сбрасываем период
                document.getElementById('current-period').value = '3';
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('[data-period="3"]').classList.add('active');

                // Обновляем отображение данных
                updateDataDisplay();

                // Обновляем отображение времени
                updateMatchTimeDisplay();

                // Скрываем клавиатуру
                keyboard.style.display = 'none';

                // Сбрасываем результаты
                document.getElementById('predicted-total').textContent = '--';
                document.getElementById('game-pace').textContent = '--';
                document.getElementById('period-prediction').textContent = '--';
                document.getElementById('total-recommendation').textContent = '--';
                document.getElementById('time-impact').textContent = '--';
                document.getElementById('moon-factor').textContent = '--';
                document.getElementById('day-factor').textContent = '--';
                document.getElementById('fatigue-factor').textContent = '--';
                document.getElementById('gender-factor').textContent = '--';
            }
        });
        
        // Функция обновления отображения времени матча
        function updateMatchTimeDisplay() {
            const period = document.getElementById('current-period').value;
            const timeRemaining = document.getElementById('time-remaining').value;
            const champ = championships[currentChampionship];
            
            let periodText;
            if (champ.periods === 2) {
                // Для формата с двумя таймами
                periodText = period === '1' ? '1-й тайм' : 
                            period === '2' ? '2-й тайм' : 
                            period === 'ot' ? 'Овертайм' : `${period}-й овертайм`;
            } else {
                // Для формата с четырьмя периодами
                periodText = period === '1' ? '1-я четверть' : 
                            period === '2' ? '2-я четверть' : 
                            period === '3' ? '3-я четверть' : 
                            period === '4' ? '4-я четверть' : 
                            period === 'ot' ? 'Овертайм' : `${period}-й овертайм`;
            }
            
            // Если время пустое, не отображаем его
            const timeDisplay = timeRemaining ? `, ${timeRemaining}` : '';
            document.getElementById('match-time-editable').innerHTML = `${periodText}${timeDisplay}`;
        }
        
        // Функция расчета прогнозов с учетом пола и лунных циклов - ИСПРАВЛЕННАЯ
        function calculatePredictions() {
            // Получаем текущую дату и рассчитываем фазу Луны
            const currentDate = new Date();
            currentMoonPhase = calculateMoonPhase(currentDate);
            const moonPhaseName = getMoonPhaseName(currentMoonPhase);
            currentMoonInfluence = calculateMoonInfluence(currentMoonPhase, currentGender);
            
            // Определяем день недели и коэффициент влияния
            const dayOfWeek = currentDate.getDay();
            const dayFactor = dayFactors[dayOfWeek];
            
            // Определяем временной интервал и коэффициент усталости
            const hours = currentDate.getHours();
            const timeInterval = getTimeInterval(hours);
            const fatigueFactor = fatigueFactors[timeInterval];
            
            // Обновляем отображение информации о факторах
            document.getElementById('moon-factor').textContent = `${moonPhaseName} (${((currentMoonInfluence.influence - 1) * 100).toFixed(1)}%)`;
            document.getElementById('day-factor').textContent = `${dayFactor.name} (${((dayFactor.factor - 1) * 100).toFixed(1)}%)`;
            document.getElementById('fatigue-factor').textContent = `${fatigueFactor.name} (${((fatigueFactor.factor - 1) * 100).toFixed(1)}%)`;
            
            // Обновляем отображение информации о поле
            const genderText = currentGender === 'men' ? 'Мужчины (+5%)' : 'Женщины (-5%)';
            document.getElementById('gender-factor').textContent = genderText;
            
            // Применяем классы для визуального отображения влияния факторов
            applyFactorClasses();
            
            const champ = championships[currentChampionship];
            const isCyber = champ.periodLength <= 5;

            // Получаем значения из формы
            const currentPeriod = document.getElementById('current-period').value;
            const timeRemaining = document.getElementById('time-remaining').value;
            const totalPoints = parseInt(document.getElementById('total-points').value) || 0;
            const avgPoints = parseInt(document.getElementById('avg-points').value) || champ.avgPoints;
            
            // Парсим оставшееся время
            const timeParts = timeRemaining.split(':');
            const remainingMinutes = parseInt(timeParts[0]) || 0;
            const remainingSeconds = parseInt(timeParts[1]) || 0;
            const totalRemainingSeconds = remainingMinutes * 60 + remainingSeconds;
            
            // РАСЧЕТ ПРОШЕДШЕГО ВРЕМЕНИ - ИСПРАВЛЕННЫЙ
            let elapsedMinutes = 0;
            let isOvertime = false;
            let periodsCompleted = 0;
            
            if (currentPeriod === 'ot') {
                isOvertime = true;
                // Регулярное время полностью сыграно + часть овертайма
                periodsCompleted = champ.periods;
                elapsedMinutes = (champ.periodLength * periodsCompleted) + 
                                (champ.otLength - (totalRemainingSeconds / 60));
            } else {
                const periodNum = parseInt(currentPeriod);
                isOvertime = periodNum > champ.periods;
                
                if (!isOvertime) {
                    periodsCompleted = periodNum - 1;
                    elapsedMinutes = (champ.periodLength * periodsCompleted) + 
                                    (champ.periodLength - (totalRemainingSeconds / 60));
                } else {
                    // Многократный овертайм
                    const overtimeNum = periodNum - champ.periods;
                    periodsCompleted = champ.periods + (overtimeNum - 1);
                    elapsedMinutes = (champ.periodLength * champ.periods) + 
                                    (champ.otLength * (overtimeNum - 1)) + 
                                    (champ.otLength - (totalRemainingSeconds / 60));
                }
            }
            
            // Рассчитываем текущий темп игры (очков в минуту) - ИСПРАВЛЕННЫЙ
            const gamePace = elapsedMinutes > 0 ? (totalPoints / elapsedMinutes).toFixed(2) : (avgPoints / champ.periodLength).toFixed(2);
            
            // Учет пола спортсменов для корректировки прогноза
            let genderFactor = 1.0;
            if (currentGender === 'men') {
                genderFactor = 1.05; // Мужчины +5%
            } else {
                genderFactor = 0.95; // Женщины -5%
            }
            
            // Корректируем темп игры на основе пола, фазы луны, дня недели и усталости
            const adjustedGamePace = (parseFloat(gamePace) * genderFactor * currentMoonInfluence.influence * dayFactor.factor * fatigueFactor.factor).toFixed(2);
            
            // ПРОГНОЗ ОБЩЕГО КОЛИЧЕСТВА ОЧКОВ - ИСПРАВЛЕННЫЙ
            let totalProjected;
            let remainingRegularTime = 0;
            
            if (!isOvertime) {
                const periodNum = parseInt(currentPeriod);
                // Оставшееся регулярное время
                remainingRegularTime = (champ.periodLength * (champ.periods - periodNum)) + (totalRemainingSeconds / 60);
                totalProjected = Math.round(totalPoints + (parseFloat(adjustedGamePace) * remainingRegularTime));
            } else {
                // В овертайме прогнозируем только до конца текущего овертайма
                const remainingOvertime = totalRemainingSeconds / 60;
                totalProjected = Math.round(totalPoints + (parseFloat(adjustedGamePace) * remainingOvertime));
            }
            
            // Прогноз на конец периода - ИСПРАВЛЕННЫЙ
            let periodProjection;
            if (!isOvertime) {
                periodProjection = Math.round(parseFloat(adjustedGamePace) * champ.periodLength);
            } else {
                periodProjection = Math.round(parseFloat(adjustedGamePace) * champ.otLength);
            }
            
            // Рекомендация по тоталу - ИСПРАВЛЕННАЯ
            const avgTotal = champ.periods * avgPoints;
            let totalRecommendation;
            
            if (isOvertime) {
                totalRecommendation = "Овертайм - осторожно";
            } else if (totalProjected > avgTotal + 10) {
                totalRecommendation = "Высокий темп - БОЛЬШЕ";
            } else if (totalProjected < avgTotal - 10) {
                totalRecommendation = "Низкий темп - МЕНЬШЕ";
            } else {
                totalRecommendation = "Средний темп - НЕЙТРАЛЬНО";
            }
            
            // Отображаем влияние времени на прогноз
            let timeImpactText = "";
            const paceValue = parseFloat(adjustedGamePace);
            
            if (paceValue > 2.0) {
                timeImpactText = "Очень высокий темп игры";
            } else if (paceValue > 1.7) {
                timeImpactText = "Высокий темп игры";
            } else if (paceValue > 1.4) {
                timeImpactText = "Средний темп игры";
            } else {
                timeImpactText = "Низкий темп игры";
            }
            
            // Добавляем информацию о времени
            if (!isOvertime) {
                timeImpactText += ` (осталось ${remainingRegularTime.toFixed(1)} мин)`;
            } else {
                timeImpactText += " (овертайм)";
            }
            
            // Обновляем UI с результатами
            document.getElementById('predicted-total').textContent = totalProjected;
            document.getElementById('predicted-total').className = 'result-value ' + 
                (totalProjected > avgTotal && !isOvertime ? 'positive' : 
                 totalProjected < avgTotal && !isOvertime ? 'negative' : 'neutral');
                
            document.getElementById('game-pace').textContent = adjustedGamePace + " очков/минуту";
            document.getElementById('game-pace').className = 'result-value neutral';
            
            document.getElementById('period-prediction').textContent = periodProjection + " очков";
            document.getElementById('period-prediction').className = 'result-value neutral';
            
            document.getElementById('total-recommendation').textContent = totalRecommendation;
            document.getElementById('total-recommendation').className = 'result-value ' + 
                (totalRecommendation.includes('БОЛЬШЕ') ? 'positive' : 
                 totalRecommendation.includes('МЕНЬШЕ') ? 'negative' : 'neutral');
            
            document.getElementById('time-impact').textContent = timeImpactText;
            
            // Обновляем отображение темпа игры
            document.getElementById('pace-display').textContent = adjustedGamePace;
        }
        
        // Функция для применения классов к факторам влияния
        function applyFactorClasses() {
            // Луна
            const moonEl = document.getElementById('moon-factor');
            moonEl.className = 'factor-value ' + 
                (currentMoonInfluence.influence > 1 ? 'factor-positive' : 
                 currentMoonInfluence.influence < 1 ? 'factor-negative' : 'factor-neutral');
            
            // День недели
            const dayOfWeek = new Date().getDay();
            const dayFactor = dayFactors[dayOfWeek];
            const dayEl = document.getElementById('day-factor');
            dayEl.className = 'factor-value ' + 
                (dayFactor.factor > 1 ? 'factor-positive' : 
                 dayFactor.factor < 1 ? 'factor-negative' : 'factor-neutral');
            
            // Усталость
            const hours = new Date().getHours();
            const timeInterval = getTimeInterval(hours);
            const fatigueFactor = fatigueFactors[timeInterval];
            const fatigueEl = document.getElementById('fatigue-factor');
            fatigueEl.className = 'factor-value ' + 
                (fatigueFactor.factor > 1 ? 'factor-positive' : 
                 fatigueFactor.factor < 1 ? 'factor-negative' : 'factor-neutral');
        }
        
        // Автоматический расчет при изменении данных
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                updateDataDisplay();
                calculatePredictions();
            });
        });
        
        document.getElementById('current-period').addEventListener('change', function() {
            updateMatchTimeDisplay();
            updateDataDisplay();
            calculatePredictions();
        });
        
        document.getElementById('time-remaining').addEventListener('input', function() {
            updateMatchTimeDisplay();
            updateDataDisplay();
            calculatePredictions();
        });
        
        // Инициализация расчетов при загрузке
        window.addEventListener('load', function() {
            setDefaultAvgPoints();
            updateMatchTimeDisplay();
            updateDataDisplay();
            calculatePredictions();
            
            // На iOS устройствах отключаем стандартную клавиатуру
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                document.querySelectorAll('input').forEach(input => {
                    input.setAttribute('readonly', 'readonly');
                });
            }
            
            // Предотвращаем масштабирование при двойном тапе
            document.addEventListener('dblclick', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            // Предотвращаем масштабирование жестом двумя пальцами
            document.addEventListener('touchstart', function(event) {
                if (event.touches.length > 1) {
                    event.preventDefault();
                }
            });
            
            // Предотвращаем двойной тап (быстрое двойное касание) для масштабирования
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        });
    </script>
</body>
</html>
